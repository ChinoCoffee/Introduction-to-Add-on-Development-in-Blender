<div id="sect_title_img_3_6"></div>

<div id="sect_title_text"></div>

# 音を鳴らす

<div id="preface"></div>

###### 本節ではBlenderが提供するオーディオファイルの再生支援モジュールであるaudモジュールを使って、オーディオファイルを再生する方法を説明します。3DCGを作成するBlenderのアドオンではオーディオファイルを扱うことはほとんどないと思いますが、こういうアドオンもあるのだという気持ちで読んでもらえればと思います。


## 作成するアドオンの仕様

* *3Dビュー* エリアのツール・シェルフに *オーディオ再生* パネルを追加し、選択したオーディオファイルを再生する簡易オーディオプレイヤーを作成する
* オーディオプレイヤーは以下の機能を持つ
  * 選択したファイルの再生・一時停止・一時停止解除・停止
  * ループ再生
  * 音量変更
  * ピッチ変更

## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-6.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-6.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに以下の文字列が出力されます。

```sh
サンプル3-6: アドオン「サンプル3-6」が有効化されました。
```

また、*3Dビュー* エリアのツール・シェルフに *オーディオ再生* パネルが追加されます。

### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのツール・シェルフから *オーディオ再生* パネルを選択します。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オーディオファイルを選択* ボタンをクリックします。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|ファイルブラウザが開くため、再生するオーディオファイルを選択して *オーディオファイルの選択* ボタンをクリックします。本節のサンプルでは、デフォルトで *.wav* 形式と *.mp3* 形式の2つの拡張子に絞って表示していますが、*ファイルのフィルタリングを有効化ボタン* をクリックすることで、他のファイルも選択できるようになります。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">4</div>|*再生* ボタンをクリックすると、オーディオファイルが再生されます。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">5</div>|*音量* や *ピッチ* を変更することに加え、オーディオファイルの再生一時停止やループ再生もできます。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに以下の文字列が出力されます。

```sh
サンプル3-6: アドオン「サンプル3-6」が無効化されました。
```

## ソースコードの解説

本節のサンプルは、オーディオファイルの再生に加えて様々な機能を追加しているため、ソースコードの規模が大きくなっています。このため、最初にBlenderのAPIを使ったオーディオファイルの再生手順を説明した後、本節のサンプルの説明を行います。

### オーディオファイルの再生手順概要

Blenderが提供するAPIを使ってオーディオファイルを再生する手順を次に示します。

1. audモジュールをインポート
2. サウンドデバイスを作成
3. サウンドファクトリを作成
4. サウンドハンドラを作成（オーディオファイルを再生）


BlenderのAPIを使ってオーディオファイルを再生するためには、audモジュールをインポートする必要があります。

[import:"import_aud", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-6.py)


サウンドデバイスとサウンドファクトリは、```aud.device()``` 関数および ```aud.Factory()``` 関数を実行することで作成することができます。```aud.device()``` 関数は引数が不要ですが、```aud.Factory()``` 関数は再生するオーディオファイルのパスを引数に指定する必要があります。ここで、サウンドデバイスとサウンドファクトリという2つの用語が出てきましたが、これらは何を指しているのでしょうか？

サウンドデバイスはOpenALやSDLなどのサウンドライブラリで扱うデバイスのことを指し、オーディオを出力するために必要なものです。サウンドファクトリは複数の音源をミックスしたり、ハイパスフィルター（HPF）やローパスフィルター（LPF）などのエフェクトをかけたりするためのオブジェクトです。サウンドを編集する時に使うことがあるかもしれませんが、Blenderはあくまで3DCGソフトなので本節のサンプルではこれらの機能を使っていません。（筆者はサウンドプログラミングに興味があり、もう少し詳しく書きたいのですが、関係ない人には全く意味のない話題にページを使うのはやめました・・・）


最後に、```aud.device()``` の戻り値の ```play()``` メソッドに ```aud.Factory()``` の戻り値を引数に代入することで、サウンドハンドラが作成されてオーディオファイルが再生されます。サウンドハンドラは戻り値で取得でき、停止/一時停止/再生再開に加えて、ピッチやボリュームを変更するためのオブジェクトです。


### オーディオファイルの選択

再生するオーディオファイルを選ぶ処理は、```SelectAudioFile``` で行います。```SelectAudioFile``` は、[2-10節](../chapter_02/10_Control_Blender_UI_3.md) で説明したファイルブラウザを表示するための処理です。

ファイルブラウザの表示に関しては、[2-10節](../chapter_02/10_Control_Blender_UI_3.md) と同じですが1点だけ異なるところがあり、本節のサンプルではwavファイルとmp3のファイルしか表示されません。このように、特定のファイルのみを表示したい場合は ```filter_glob``` クラス変数を宣言します。```filter_glob``` は ```StringProperty``` クラスで定義し、```default``` に表示するファイルのリストを ```;``` （セミコロン）区切りで指定します。なお、正規表現を使うことができます。本節のサンプルでは全てのwavファイルとmp3ファイルを表示するため、```*.wav; *.mp3``` を指定しています。

[import:"filter_glob", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-6.py)

ファイル名指定でフィルタリングできるか確認すること。

ファイルブラウザでファイルを選択すると ```execute()``` メソッドが実行されます。

[import:"select_audio_file_execute", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-6.py)

処理の流れは、オーディオファイルの再生手順概要で示した通りです。サウンドデバイスは一度作成すればよく、オーディオファイルの選択は複数回実行されることを想定し、サウンドデバイスが初回のみ作成されるようにしています。また、オーディオファイルを再生中である場合は停止する処理も追加しています。


## まとめ




<div id="point"></div>

### ポイント

<div id="point_item"></div>

*
