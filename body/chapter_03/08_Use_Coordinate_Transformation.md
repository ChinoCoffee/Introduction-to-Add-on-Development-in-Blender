<div id="sect_title_img_3_8"></div>

<div id="sect_title_text"></div>

# 座標変換を活用する

<div id="preface"></div>

###### [3-1節](01_Handle_Mouse_Click_Event.md) から [3-5節](05_Render_String_with_blf_Module.md) にかけてUIに関する話題を取り上げました。これらの解説で取り上げた内容をアドオンに組み込んでいくと、いずれ3Dビューエリアにおいてリージョン座標から3D空間の座標、またはその逆で3D空間からリージョン座標のように座標変換したいと思うようになります。本節では、Blenderが提供する座標変換APIを使ったアドオンを紹介したいと思います。


## 座標変換について

3Dプログラミングに馴染みのない方にとって、座標変換


## 作成するアドオンの仕様

* *3Dビュー* エリアのオブジェクト全てについて、オブジェクトの位置にオブジェクト名を表示する
* マウスカーソルの位置に向けて発した直線（レイ）と交差するオブジェクト名を表示する


## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-8.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-8.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が有効化されました。
```

また、*3Dビュー* エリアのプロパティパネルに *オブジェクト名の表示補助* が追加されていることを確認します。

### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのプロパティパネルに追加された *オブジェクト名の表示補助* の *開始* ボタンをクリックすると、オブジェクトに重なるようにオブジェクト名が表示されます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オブジェクト名の表示補助* の *フォントサイズ* から、表示されるオブジェクト名のフォントサイズを変更することができます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|*オブジェクトモード* 時に *3Dビュー* エリアでマウスを移動させると、マウスカーソルの位置に向けて発するレイと交差するオブジェクト名一覧が左上に表示されます。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">4</div>|*オブジェクト名の表示補助* の *終了* ボタンをクリックし、オブジェクト名の表示を中止します。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が無効化されました。
```



## ソースコードの解説



### bpy_extraモジュール

Blenderが提供するAPIの大半は ```bpy``` モジュールとして提供され、ほとんどのアドオン開発者はこのモジュールを使ってアドオンを開発することが多いと思います。しかし、```bpy``` モジュールは基本的な機能しか提供しないため、使いづらいと感じることもあるかもしれません。このためBlenderは、開発者が比較的多く使われると想定される便利なAPI群を ```bpy_extra``` モジュールとして提供しています。```bpy_extra``` モジュールを利用することで面倒な処理を1から実装することなく実現できるため、機能を実装する際に面倒だと思ったら ```bpy_extra``` モジュールで実現したい処理がAPIとして提供されていないかを確認してみましょう。

次に示すように、```bpy_extra``` モジュールは複数のサブモジュールから構成されています。

|サブモジュール名|概要|
|---|---|
|```anim_utils```|アニメーション関連の便利API|
|```object_utils```|オブジェクト操作関連の便利API|
|```io_utils```|インポータ/エクスポータ向けの便利APIやファイルパスに関する便利API|
|```image_utils```|画像ファイルの読込みに関する便利API|
|```keyconfig_utils```|キーコンフィグ関連の便利API|
|```mesh_utils```|メッシュ型オブジェクトに関する便利API|
|```view3d_utils```|3Dビューエリア上で座標変換を容易に行うためのAPI|


本節で使用している座標変換のAPIを利用するためには、```bpy_extra``` モジュールの ```view3d_utils``` をインポートする必要があります。

[import:"import_view3d_utils", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)


### オブジェクトの位置にオブジェクト名を表示する

*3Dビュー* エリアに配置されているオブジェクトに重なるようにオブジェクト名を表示するためには、次の手順に従います。

1. オブジェクトの位置座標を取得する


### マウスカーソルの位置に向けて発したレイと交差するオブジェクト名を表示する

マウスカーソルの位置に向けて発したレイと交差するオブジェクト名を表示するためには、次の手順に従います。

1. マウスカーソルのリージョン座標を取得する
2. リージョン座標から、レイの向きと発生源の座標を求める
3. レイの始点と終点の座標を求める
4. レイと *3Dビュー* エリアに配置されているオブジェクトとの交差判定を行う
5. レイと交差したオブジェクト名を表示する

1〜4の処理は、```ShowObjectName``` クラスの ```modal()``` メソッド、5の処理は ```render()``` スタティックメソッドで行っています。それぞれの処理について、解説します。


#### 1. マウスカーソルのリージョン座標を取得する

マウスカーソルのリージョン座標を取得するためのコードを次に示します。マウスカーソルのリージョン座標は、```mouse_region_x``` （X座標）と ```mouse_region_y``` （Y座標）で取得することができます。

[import:"get_mouse_region_coord", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)


#### 2. リージョン座標から、レイの向きと発生源の座標を求める

1で取得したマウスカーソルのリージョン座標からレイの向きと発生源の座標を求めます。これらの座標変換を1から実装するとなると、カメラのビュー行列などを用いて行列計算を行う必要があります。幸いなことに ```bpy_extra``` モジュールの ```view3d_utils``` サブモジュールが提供するAPIを利用することで、この処理を比較的簡単な方法で実現することができます。

リージョン座標から、レイの向きと発生源の座標を求めるためのコードを以下に示します。

[import:"calc_ray_dir_and_orig", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

レイの発生源は、*3Dビュー* エリアの3D空間を映し出しているカメラの座標（視点）となるため、```view3d_utils.region_2d_to_origin_3d()``` 関数を使って取得することができます。一方レイの向きは、視点からマウスカーソルのリージョン座標を *3Dビュー* の3D空間座標に変換した座標の点への向きとなるため、```view3d_utils.region_2d_to_vector_3d()``` 関数を使って取得することができます。```view3d_utils.region_2d_to_vector_3d()``` 関数と ```view3d_utils.region_2d_to_origin_3d()``` 関数の引数を次に示すように共に同じ引数を受け取ります。

|引数|意味|
|---|---|
|第1引数|座標変換対象のリージョン|
|第2引数|座標変換対象の3Dリージョンデータ|
|第3引数|リージョン座標|

座標変換対象のリージョンは ```get_region``` スタティックメソッド、3Dリージョンデータは ```get_space``` スタティックメソッドで取得できるスペースから取得します。本節のサンプルでは、*3Dビュー* エリアのウィンドウリージョンを座標変換対象としたいため、リージョン ```WINDOW``` とスペース ```VIEW_3D``` を取得しています。


#### 3. レイの始点と終点の座標を求める

4で使用する ```ray_cast``` 関数は、引数にレイの始点と終点を指定する必要があります。このため次のコードにより、2で取得したレイの向きと発生源の座標からレイの視点と終点を求めます。

[import:"calc_ray_start_end", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

レイの始点はレイの発生源と同じです。一方レイの終点は、レイの発生源からレイの方向に伸ばした線上に設定します。本節では、発生源から距離が2000離れたところに終点を設定しています。このため、レイの発生源から2000以上離れたオブジェクトは交差判定の対象外となります。

なお ```ray_cast()``` によるレイとオブジェクトの交差判定は、**オブジェクトのローカル座標で行います** 。このため、レイの始点と終点もオブジェクトのローカル座標に座標変換する必要があります。本節のサンプルでは、オブジェクトの位置を原点に移動するようにレイの始点と終点の座標を移動し、```ray_cast()``` の引数に指定しました。


//[TODO] locationでも実現できる？

#### 4. レイと3Dビューエリアに配置されているオブジェクトとの交差判定を行う

レイとオブジェクトの交差判定は、```ray_cast()``` 関数で行うことができます。しかし ```ray_cast()``` 関数には、*オブジェクトモード* 以外で実行できないという制限があります。このため本節のサンプルでは、 *オブジェクトモード* 時にレイと交差したオブジェクト名を表示するようにしています。

[import:"check_intersection", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

レイと交差したオブジェクトは、メンバ変数 ```intersected_objs``` に保存します。レイとオブジェクトが交差したことは、```ray_cast()``` 関数の戻り値で確認します。```ray_cast()``` 関数の戻り値は次に示すタプル型の値で、本節のサンプルでは ```ray_cast()``` の戻り値の第3要素が ```-1``` 以外の場合にレイが交差したと判定します。

|戻り値|意味|
|---|---|
|第1要素|レイが交差した座標|
|第2要素|レイが交差した面の法線|
|第3要素|レイが交差した面のインデックス（交差した面が存在しない場合は-1）|


本節のサンプルでは ```ray_cast()``` の処理を ```try``` ブロックで囲み、例外処理を実装しています。これはメッシュ型のオブジェクトを作成した時に、作成タイミングの問題で ```ray_cast()``` の処理を実行できない場合に例外が発生し、処理が中断してしまうことを避けるためです。この問題を避けるために ```ray_cast()``` 関数を実行するオブジェクトをメッシュ型に絞っていますが、ここまで対処してもタイミングによって時々例外が発生してしまうことから、安全面を重視して例外処理を追加しています。


[TODO] バージョンの違いを記載すること


#### 5. レイと交差したオブジェクト名を表示する

レイと交差したオブジェクト名は、```render()``` スタティックメソッドで表示しています。メンバ変数 ```intersected_objs``` にレイと交差したオブジェクトが格納されていることを利用し、[3-5節](05_Render_String_with_blf_Module.md) で説明した関数と同じである ```render_message()``` スタティックメソッドでオブジェクト名を表示します。


## まとめ




<div id="point"></div>

### ポイント

<div id="point_item"></div>

*
