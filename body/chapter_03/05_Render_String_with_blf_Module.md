<div id="sect_title_img_3_5"></div>

<div id="sect_title_text"></div>

# blfモジュールを使ってテキストを描画する

<div id="preface"></div>

###### [3-4節](04_Use_API_for_OpenGL.md) ではOpenGLのAPIを利用した図形描画を行う方法を説明しましたが、本節のサンプルではテキストを描画する方法を説明します。本節では [3-3節](03_Handle_Timer_Event.md) のサンプルを改造したアドオンを用いて説明しますが、可能な限りテキスト描画の説明に閉じて説明しますので、必ずしも [3-3節](03_Handle_Timer_Event.md) をすべて理解する必要はありません。


## 作成するアドオンの仕様

* [3-3節](03_Handle_Timer_Event.md) を改造し、作業時間を *3Dビュー* エリアのウィンドウ左上部に表示する

## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-5.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-5.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに以下の文字列が出力されます。

```sh
サンプル3-5: アドオン「サンプル3-5」が有効化されました。
```



### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのプロパティパネルの *作業時間計測* に配置されている *開始* ボタンを押すと、アクティブなオブジェクトに対する作業時間の計測が始まります。||
|---|---|---|

<div id="process_sep"></div>

---

|<div id="box">2</div>|作業時間を表示したいオブジェクトをコンボボックスから選択すると、選択したオブジェクトについてオブジェクトモードとエディットモードでの作業時間が、*3Dビュー* エリアのウィンドウ左上部に表示されます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="tips"></div>

[3-3節](03_Handle_Timer_Event.md) と同様、本節のサンプルでも作業時間計測後のオブジェクト名変更には対応していません。  
オブジェクト名を変更すると、名前変更後のオブジェクトが新たに追加されたものとして作業時間が計測されます。


|<div id="box">3</div>|*終了* ボタンを押すと、作業時間の計測が止まります。なお、計測を止めると同時に作業時間の表示が消えます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに以下の文字列が出力されます。

```sh
サンプル3-5: アドオン「サンプル3-5」が無効化されました。
```

## ソースコードの解説

本節のサンプルは、[3-3節](03_Handle_Timer_Event.md) のソースコードを改造したものであるため、改造した箇所を中心に説明します。

### テキスト描画APIを利用する

本節のサンプルでは、任意のテキストを描画するためにBlenderが提供するAPIを利用します。

テキストを描画するためのAPIをアドオンから利用するためには、```blf``` モジュールをインポートする必要があります。

[import:"import_blf", unindent:"true"](../../sample/src/chapter_03/sample_3-5.py)


### 描画関数を登録する

テキストを描画するためには、[3-4節](04_Use_API_for_OpenGL.md) で ```bgl``` モジュールを使って図形を描画した時と同様、描画関数を登録する必要があります。描画関数の登録は、```__handle_add()``` メソッド内の ```bpy.types.SpaceView3D.draw_handler_add()``` 関数で行ないます。具体的な引数の型などは、[3-4節](04_Use_API_for_OpenGL.md) と同じのため説明は省略します。

[import:"add_render_func", unindent:"true"](../../sample/src/chapter_03/sample_3-5.py)

本節のサンプルにおける描画関数は、```render_working_hours()``` スタティックメソッドです。


### 描画関数の処理

描画関数 ```render_working_hours()``` スタティックメソッドは描画先のリージョンを ```get_region()``` スタティックメソッドで取得した後、```render_message()``` スタティックメソッドを使って指定した座標に作業時間の計測結果を表示します。

#### リージョンの取得

[3-4節](04_Use_API_for_OpenGL.md) で説明したように、ウィンドウの座標は左下が (x, y) = (0, 0) でした。
本節のサンプルではウィンドウの左上に座標に表示する必要がありますが、左上の座標は環境によって変化するため単純に数値をそのまま入力して左上に表示されるように調整しただけでは、ウィンドウのサイズを変更した時にうまくいきません。このため、左上の座標を常に取得しておく必要があります。




### 描画関数の登録を解除する

[3-4節](04_Use_API_for_OpenGL.md) と同様に登録した描画関数は、描画処理を停止するときに登録を解除する必要があります。

[import:"remove_render_func", unindent:"true"](../../sample/src/chapter_03/sample_3-5.py)



## まとめ




<div id="point"></div>

### ポイント

<div id="point_item"></div>

*
