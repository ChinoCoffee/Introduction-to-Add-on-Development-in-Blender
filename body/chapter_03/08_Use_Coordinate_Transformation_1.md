<div id="sect_title_img_3_8"></div>

<div id="sect_title_text"></div>

# 座標変換を活用する

<div id="preface"></div>

###### [3-1節](01_Handle_Mouse_Click_Event.md) から [3-5節](05_Render_String_with_blf_Module.md) にかけてUIに関する話題を取り上げました。これらの解説で取り上げた内容をアドオンに組み込んでいくと、いずれ3Dビューエリアにおいてリージョン座標から3D空間の座標、またはその逆で3D空間からリージョン座標のように座標変換したいと思うようになります。本節では、Blenderが提供する座標変換APIを使ったアドオンを紹介したいと思います。


## 座標変換について

筆者が初めて3Dプログラミングに挑戦した時も同じでしたが、3Dプログラミングに馴染みのない方にとって座標変換の必要性を問われてもさっぱりわからなかったりします。しかし3Dソフトや3Dソフトのアドオンを作る立場になると、どうしても座標変換を理解し使いこなせる必要が出てきます。例えば、[3-1節](01_Handle_Mouse_Click_Event.md) で紹介したように、マウスをクリックした位置の面を削除する処理を実装するためには、スクリーン上の座標から *3Dビュー* エリアの3D空間上の座標へ変更する必要があります。3Dプログラミングにおける座標変換については、世の中にすでにたくさんの解説記事や書籍があるため詳細は割愛しますが、Blenderで使われている座標変換について少し触れておきます。

Blenderは、ユーザから与えられた頂点情報（座標や法線）などをもとに3Dポリゴンを画面に表示します。この時Blenderの内部では以下の座標変換が行われています。

```sh
グローバル座標 = グローバル座標変換行列 × ローカル座標
リージョン座標 = ビューポート変換行列 × 射影変換行列 × ビュー変換行列 × グローバル座標
```

ローカル座標やグローバル座標については、おそらくBlenderをある程度使っている方であれば既に知っているかもしれません。ローカル座標は *エディットモード* 時のプロパティパネルの *トランスフォーム* の頂点で *ローカル* を選んだ時の *頂点* に表示されている座標値、グローバル座標は *グローバル* を選んだ時の *頂点* に表示されている座標値です。この時、ローカル座標に対して *オブジェクトモード* 時のプロパティパネルの *トランスフォーム* で行った変換変換処理を適用されたものがグローバル座標であることに気が付きましたでしょうか？実際にこのことを理解するために、*オブジェクトモード* でオブジェクトに座標変換した時のグローバル座標の値の変化を見てみましょう。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*エディットモード* であることを確認し、*3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *頂点* の座標値を確認します。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オブジェクトモード* に切り替え、同じく *3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *位置* の値をX方向に+1、Y方向に-1します。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|*エディットモード* に切り替え、*3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *頂点* 値を確認すると、Xの値が+1、Yの値が-1となっていることが確認できます。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process_start_end"></div>

---

このように、ローカル座標に対して *オブジェクトモード* で行った変換処理を適用することで、グローバル座標を得られることが理解できたと思います。グローバル座標からリージョン座標への変換処理についてもBlender内のデータを使って行うことができますが、あまり直感的ではないのとBlenderが提供するAPIがこの変換処理を勝手に行ってくれるので、ここでは省略します。実際に本節のサンプルを理解するためには、ローカル座標・グローバル座標・リージョン座標のみ理解しておけば問題ないです。ただし、気になる方もいると思うので、[3-9節](09_Use_Coordinate_Transformation_2.md) の一番最後に自力でローカル座標からリージョン座標へ変換する方法を紹介します。興味のある方は確認してみてください。


## 作成するアドオンの仕様

* *3Dビュー* エリアの選択されているオブジェクトについて、オブジェクトの中心座標の画面上での移動の軌跡を表示する


## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-8.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-8.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が有効化されました。
```

また、*3Dビュー* エリアのプロパティパネルに *オブジェクト名の表示補助* が追加されていることを確認します。

### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのプロパティパネルに追加された *オブジェクト名の表示補助* の *開始* ボタンをクリックすると、オブジェクトに重なるようにオブジェクト名が表示されます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オブジェクト名の表示補助* の *フォントサイズ* から、表示されるオブジェクト名のフォントサイズを変更することができます。||
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|*オブジェクトモード* 時に *3Dビュー* エリアでマウスを移動させると、マウスカーソルの位置に向けて発するレイと交差するオブジェクト名一覧が左上に表示されます。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">4</div>|*オブジェクト名の表示補助* の *終了* ボタンをクリックし、オブジェクト名の表示を中止します。||
|---|---|---|

<div id="process_sep"></div>

---


<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が無効化されました。
```



## ソースコードの解説



### bpy_extraモジュール

Blenderが提供するAPIの大半は ```bpy``` モジュールとして提供され、ほとんどのアドオン開発者はこのモジュールを使ってアドオンを開発することが多いと思います。しかし、```bpy``` モジュールは基本的な機能しか提供しないため、使いづらいと感じることもあるかもしれません。このためBlenderは、開発者が比較的多く使うと想定される便利なAPI群を ```bpy_extra``` モジュールとして提供しています。```bpy_extra``` モジュールを利用することで面倒な処理を1から実装することなく実現できるため、機能を実装する際に面倒だと思ったら ```bpy_extra``` モジュールで実現したい処理がAPIとして提供されていないかを確認してみましょう。

次に示すように、```bpy_extra``` モジュールは複数のサブモジュールから構成されています。

|サブモジュール名|概要|
|---|---|
|```anim_utils```|アニメーション関連の便利API|
|```object_utils```|オブジェクト操作関連の便利API|
|```io_utils```|インポータ/エクスポータ向けの便利APIやファイルパスに関する便利API|
|```image_utils```|画像ファイルの読込みに関する便利API|
|```keyconfig_utils```|キーコンフィグ関連の便利API|
|```mesh_utils```|メッシュ型オブジェクトに関する便利API|
|```view3d_utils```|3Dビューエリア上で座標変換を容易に行うためのAPI|


本節で使用している座標変換のAPIを利用するためには、```bpy_extra``` モジュールの ```view3d_utils``` をインポートする必要があります。

[import:"import_view3d_utils", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)


### オブジェクトの位置にオブジェクト名を表示する

*3Dビュー* エリアに配置されているオブジェクトに重なるようにオブジェクト名を表示するためには、次の手順に従います。

1. オブジェクトの位置座標を取得する
2. オブジェクトの位置座標をリージョン座標に変換する
3. オブジェクト名を表示する

具体的なコードを次に示します。

[import:"render_object_name", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

オブジェクトの位置座標は、```bpy.data.objects``` の各要素から取得できるオブジェクトデータの ```location``` メンバ変数により取得することができます。オブジェクトの位置座標をリージョン座標に変換するためには、```view3d_utils.location_3d_to_region_2d()``` 関数を使用します。```view3d_utils.location_3d_to_region_2d()``` 関数の引数を以下に示します。

|引数|意味|
|---|---|
|第1引数|座標変換対象のリージョン|
|第2引数|座標変換対象の3Dリージョンデータ|
|第3引数|3D空間の座標|

座標変換対象のリージョンは ```get_region``` スタティックメソッド、3Dリージョンデータは ```get_space``` スタティックメソッドで取得できるスペースの ```region_3d``` メンバ変数から取得します。本節のサンプルでは、*3Dビュー* エリアのウィンドウリージョンを座標変換対象としたいため、リージョン ```WINDOW``` とスペース ```VIEW_3D``` を取得しています。

オブジェクト名の表示処理については、[3-5節](05_Render_String_with_blf_Module.md) の説明を参考にしてください。


## まとめ

本節では座標変換を活用したアドオンのサンプルを紹介しました。```view3d_utils``` サブモジュールを使用することにより、自前でローカル座標とリージョン座標間の座標変換処理を実装する必要がなくなるということを理解できたのではないでしょうか。ここでは、```view3d_utils``` が提供する座標変換のAPI一覧についてまとめます。

|API|概要|
|---|---|
|```view3d_utils.region_2d_to_origin_3d()```|リージョンを映し出すカメラの位置を取得する|
|```view3d_utils.region_2d_to_vector_3d()```|リージョンを映し出すカメラの位置から、指定されたリージョン座標へ発するレイの方向を3Dベクトルで取得する|
|```view3d_utils.region_2d_to_location_3d()```|指定されたリージョン座標を、3D空間の座標へ変換する|
|```view3d_utils.location_3d_to_region_2d()```|指定した3D空間の座標を、リージョン座標へ変換する|


提供されているAPIの数は少ないですが、座標変換に限らず ```bpy_extra``` モジュールには便利なAPIが提供されているため、一度目を通しておくと良いと思います。

サンプルのアドオンでは、```ray_cast()``` 関数を使ったレイとオブジェクトの交差判定も行いました。```ray_cast()``` は非常に便利な関数で、交差した面や位置も取得することができます。例えば、マウスでクリックした時にマウスカーソルの位置に穴を開けたり、マウスカーソルが重なっている面を強調表示といった処理も ```ray_cast()``` 関数を使って実装することができると思います。

本節の最後では、```view3d_utils``` サブモジュールが内部で行っている座標変換について具体的に理解したい方向けに、自力でローカル座標からリージョン座標へ変換する方法する方法を解説しました。アドオンを作るだけであれば理解する必要がない内容ですが、Blenderがどのように座標変換を行なっているかを理解することはAPIを深く知るきっかけになるため、余力のある方は目を通しておきましょう。また、解説するために自力で座標変換を行うスクリプトを紹介しましたが、細かい最適化やエラー処理は省いています。座標変換さえ行えれば十分という方は、素直に ```view3d_utils``` のAPIを利用するようにしましょう。


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* Blenderは3Dポリゴンを画面に表示するまでに、グローバル座標変換→ビュー変換→射影変換→ビューポート変換を行なってローカル座標からリージョン座標へ座標変換する
* ```bpy_extra``` モジュールは、 ```bpy``` モジュールだけで処理を実装すると面倒な処理を開発者がAPI呼び出しだけで実現できるようにした、APIの集まりである
* ```bpy_extra``` モジュールのサブモジュールである ```view3d_utils``` サブモジュールは、*3Dビュー* エリア上で座標変換を行うためのAPIを提供する
