<div id="sect_title_img_2_8"></div>

<div id="sect_title_text"></div>

# Blender の UI を制御する①

<div id="preface"></div>

###### Blender の UI を個人の好みに合わせて修正したいと思ったことはありませんか？ Blender の UI の大半は Python で記載されているため、 Python を理解し修正できるのであれば、個人の好みで Blender の UI を変更することができます。<br>本節はアドオンを開発しないけど自分の好みで UI を変更したい、という方にも参考になると思います。

## Blender の UI は Python で制御できる

Blender の UI の大半は Python のソースコードで記載されています。
このことを確認するために、 *3Dビュー* エリアのメニューを変更してみましょう。

以下の手順で、 *3Dビュー* エリアのメニューを制御するソースコードを修正します。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのメニューにある、*現在の視点を OpenGL レンダリング* ボタンにマウスカーソルを置いて右クリックします。|![3Dビューエリアのメニューを修正する1](https://dl.dropboxusercontent.com/s/aas9w46b84us2oi/control_UI_on_View3D_1.png "3Dビューエリアのメニューを修正する1")|
|---|---|---|

<div id="process_sep"></div>

---
<div id="process"></div>

|<div id="box">2</div>|*ソース編集* をクリックします。|![3Dビューエリアのメニューを修正する2](https://dl.dropboxusercontent.com/s/jcn6stvh67cg2bx/control_UI_on_View3D_2.png "3Dビューエリアのメニューを修正する2")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">3</div>|*テキストエディタ* エリアにソースコードが表示されます。また、 *現在の視点を OpenGL レンダリング* ボタンを表示するための処理にマウスカーソルが自動的に移動しています。|![3Dビューエリアのメニューを修正する3](https://dl.dropboxusercontent.com/s/f4j1ny6sxio3hmm/control_UI_on_View3D_3.png "3Dビューエリアのメニューを修正する3")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">4</div>|マウスカーソルの行をコメントアウトしましょう。|![3Dビューエリアのメニューを修正する4](https://dl.dropboxusercontent.com/s/h9l4jjzpqm2uu0t/control_UI_on_View3D_4.png "3Dビューエリアのメニューを修正する4")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">5</div>|*テキストエディタ* エリアのメニュー *テキスト* から *保存* を実行し、上書き保存します。|![3Dビューエリアのメニューを修正する5](https://dl.dropboxusercontent.com/s/8ubgqqmhlunz3oh/control_UI_on_View3D_5.png "3Dビューエリアのメニューを修正する5")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">6</div>|[1-4節](../chapter_01/04_Understand_Install_Uninstall_Update_Add-on.md) で紹介した *Reload Scripts* 機能を用いてアップデートすると、 *3Dビュー* エリアのメニューから *現在の視点を OpenGL レンダリング* ボタンが消えます。|![3Dビューエリアのメニューを修正する6](https://dl.dropboxusercontent.com/s/tuq7juvk8ya4xbh/control_UI_on_View3D_6.png "3Dビューエリアのメニューを修正する6")|
|---|---|---|

<div id="process_start_end"></div>

---

元の *3Dビュー* エリアのメニューに戻すためには先ほどコメントアウトした行のコメントを外して保存し、アップデートすることで元に戻すことができます。

ここまでの説明で、 Blender の UI は Python で制御されていることが理解できたのではないでしょうか。
以降の説明では、 Blender の UI を Python から構築する時に知っておくと良いことなどをサンプルを用いて説明します。

## 作成するアドオンの仕様

* 以下のようなタブを *3Dビュー* エリアの *ツール・シェルフ* に追加する

![アドオンの仕様](https://dl.dropboxusercontent.com/s/ial27tu1ousllmx/specification.png "アドオンの仕様")


* 追加したタブは、 *オブジェクトモード* 時かつオブジェクトが選択されている時のみ表示される

## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードを テキスト・エディタに入力し、ファイル名を ```sample_2-8.py``` として保存してください。

[import](../../sample/src/chapter_02/sample_2-8.py)


## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールに以下の文字列が出力されます。

```sh
サンプル2-8: アドオン「サンプル2-8」が有効化されました。
```

そして、 *3Dビュー* エリアの *ツール・シェルフ* にタブ *カスタムメニュー* が追加されます。
タブは *オブジェクトモード* 時かつオブジェクトが 1 つでも選択されている時のみ表示されます。
*エディットモード* または、*オブジェクトモード* でもオブジェクトが 1 つも選択されていない場合は表示されません。

また、 *3Dビュー* エリアのメニュー *オブジェクト* に *項目 1* と *項目2* が追加されます。

### アドオンの機能を使用する

*3Dビュー* エリアの *ツール・シェルフ* にタブ *カスタムメニュー* をクリックすると、カスタムメニューのメニューが表示されます。

カスタムメニューに表示されたボタンやメニューなどをクリックしたり選択したりできますが、基本的に何も起こりません。


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールに以下の文字列が出力されます。

```sh
サンプル2-8: アドオン「サンプル2-8」が無効化されました。
```


## ソースコードの解説

本節のサンプルプログラムは UI の種類が多いためソースコードの分量が多いですが、それぞれの UI を構築するソースコードは短いので UI ごとに説明していきます。

### ツール・シェルフのタブを追加する

本節のサンプルでは、ツール・シェルフのタブを追加しています。
アドオンの機能をタブとしてまとめることで、ユーザはそのアドオンがどのような機能を持っているかが一目でわかるようになります。

また、普段よく使う機能をタブにまとめ、独自の UI を構築して Blender の利便性良いかもしれません。

ツール・シェルフのタブに追加するためには、以下に示すような ```bpy.types.Panel``` クラスを継承したパネルクラスを作成する必要があります。

```python
# ツール・シェルフに「カスタムメニュー」タブを追加
class VIEW3D_PT_CustomMenu(bpy.types.Panel):
    bl_label = "カスタムメニュー"       # タブに表示される文字列
    bl_space_type = 'VIEW_3D'           # メニューを表示するエリア
    bl_region_type = 'TOOLS'            # メニューを表示するリージョン
    bl_category = "カスタムメニュー"    # タブを開いたメニューのヘッダーに表示される文字列
```

本節のサンプルでは、 ```bpy.types.Panel``` クラスを継承した ```VIEW3D_PT_CustomMenu``` クラスを作成しています。
基本的に自由にクラス名をつけることができますが、 Blender では ```<エリア名>_<タイプ>_<クラスを表す適切な名前>``` のように命名されていることが多いようなので、本節のサンプルではそれに合わせてみました。
ここで ```<タイプ>``` には、継承する型に応じて以下のような文字列が対応します。


|文字列|型|
|---|---|
|```MT```|```bpy.types.Menu```|
|```PT```|```bpy.types.Panel```|

クラス ```VIEW3D_PT_CustomMenu``` には、メンバ変数が4つ定義されています。

```bl_label``` は、ツール・シェルフのタブに表示される文字列を指定します。

|メンバ変数|値の意味|
|---|---|
|```bl_label```|パネルに登録時に、タイトルとして表示される文字列。ツール・シェルフに登録する場合はタブに表示される文字列となる|
|```bl_space_type```|登録先のエリア|
|```bl_region_type```|登録先のリージョン|
|```bl_category```|ツール・シェルフのタブを開いたときに表示されるメニューのヘッダーに表示される文字列|

メンバ変数 ```bl_space_type``` には登録先のエリアを指定します。今回は3Dビューエリアに登録することを考えて ```VIEW_3D``` を指定しています。

メンバ変数 ```bl_space_type``` には、他にも以下のような値を指定することができます。

|設定値|値の意味|
|---|---|
|```VIEW_3D```|*3Dビュー*|
|```IMAGE_EDITOR```|*UV/画像エディター*|
|```NLA_EDITOR```|*NLAエディター*|
|```NODE_EDITOR```|*ノードエディター*|
|```LOGIC_EDITOR```|*ロジックエディター*|
|```SEQUENCE_EDITOR```|*ビデオシーケンスエディター*|
|```GRAPH_EDITOR```|*グラフエディター*|

メンバ変数 ```bl_region_type``` には登録先のリージョンを指定します。今回はツール・シェルフに登録するため、　```TOOLS``` を指定しています。

メンバ変数 ```bl_region_type``` には、他にも以下のような値を設定することが可能です。

|設定値|値の意味|
|---|---|
|```UI```|*プロパティパネル*|
|```TOOLS```|*ツール・シェルフ*|
|```TOOL_PROPS```|*ツール・シェルフ* のプロパティ|


```VIEW3D_PT_CustomMenu``` クラスには、 ```poll()``` メソッド・ ```draw_header()``` メソッド・ ```draw()``` メソッドが定義されています。
それぞれのメソッドは以下の処理を行います。
定義したメソッドの詳細については後ほど説明します。

|メソッド|処理|
|---|---|
|```poll()```|本メソッドが定義されたクラスの処理が実行可能な状態にあるかを判定するメソッド。```True``` を返すと実行可能と判断し、 ```False``` を実行不可能であると判断する。実行不可能と判断されると、本メソッドが定義されたクラスはいかなる処理も無効化される|
|```draw_header()```|ヘッダーを描画するメソッド|
|```draw()```|メニューを描画するメソッド。本メソッドでは、ヘッダー部の UI を変更することはできない|


### タブが表示される条件を設定する

本節のサンプルでは、 *オブジェクトモード* 時かつオブジェクトが選択されている時のみタブが表示される仕様としていました。
特定の状況下でのみメニューを表示したり、処理を実行させるようにしたりするためには ```poll()``` メソッドとメンバ変数 ```bl_context``` 活用します。

```bl_context``` は、パネルクラス時に指定することが可能なメンバ変数で、指定したコンテキストである時にパネルの描画処理を実行します。
```bl_context``` には以下のような値を設定することができます。

|値|説明|
|---|---|
|```objectmode```|オブジェクトモード時のみ描画する|
|```mesh_edit```|エディットモード時のみ描画する|

本節のサンプルではタブをオブジェクトモード時のみ描画するため、```bl_context = "objectmode"``` としています。

また、```poll()``` メソッドではオブジェクトが選択されている時に描画する処理を追加しています。

```python
# 本クラスの処理が実行可能かを判定する
@classmethod
def poll(cls, context):
    # オブジェクトが選択されている時のみメニューを表示させる
    for o in bpy.data.objects:
        if o.select:
            return True
    return False
```

```poll()``` メソッドはクラス単位の処理となるため、クラスメソッドとして定義する必要があります。
このため、メソッドの前にデコレータ ```@classmethod``` をつける必要があります。
```poll()``` メソッドに渡されてくる引数は以下の通りです。

|引数|型|意味|
|---|---|
|```cls```|```bpy.types.RNAMeta```|```poll()``` メソッドを実装したクラス|
|```context```|```bpy_types.Context```|```poll()``` メソッド実行時のコンテキスト|

```poll()``` メソッド内では、 ```bpy.data.objects``` からオブジェクトを全て取得して、選択されているオブジェクトが存在する場合は ```True``` を返しています。
これにより、選択されているオブジェクトが 1 つでもあればタブが表示されます。


### ヘッダーの UI を変更する

タブに追加したメニューのヘッダーの UI を変更するためには、パネルクラスの ```draw_header()``` メソッドを定義します。

```python
# ヘッダーのカスタマイズ
def draw_header(self, context):
    layout = self.layout
    layout.label(text="", icon='PLUGIN')
```

```draw_header()``` メソッドの引数は、以下の通りです。

|引数|型|値の説明|
|---|---|---|
|```self```|呼ばれた ```draw_header()``` メソッドを定義しているクラス|オペレータクラスのインスタンス|
|```context```|```bpy_types.Context```|```draw_header()``` メソッド実行時のコンテキスト|

```draw_header()``` メソッドでは、メニューのヘッダーに表示される文字列の左にアイコンを追加する処理を行っています。

```layout.label()``` の引数を以下に示します。

|引数|値の意味|
|---|---|
|```text```|表示する文字列|
|```icon```|表示するアイコン|

本節のサンプルでは文字列を追加したくはないので、引数 ```text``` に空の文字列、引数 ```icon``` にプラグインのアイコン ID を指定しています。


#### オプションの UI をカスタマイズする

[2-3節](../chapter_02/03_Use_Property_on_Tool_Shelf_1.md) で説明した、ツール・シェルフのオプションの UI もカスタマイズできます。

オプションの UI をカスタマイズするために、本節のサンプルでは ```ShowAllIcons``` というオペレータクラスを作成しています。
このクラスは、 Python から利用できるすべてのアイコンをツール・シェルフのオプションに表示する処理を定義しています。

オプションの UI をカスタマイズする処理を以下に示します。


```python
# オプションのUI
def draw(self, context):
    layout = self.layout

    layout.prop(self, "num_column")

    layout.separator()

    # 利用可能なアイコンをすべて表示
    layout.label(text="利用可能なアイコン一覧:")
    for i, key in enumerate(bpy.types.UILayout.bl_rna.functions['prop'].parameters['icon'].enum_items.keys()):
        if i %self.num_column == 0:
            row = layout.row()
        row.label(text=key, icon=key)
```

オプションの UI は、オペレータクラスの ```draw()``` メソッドで行います。
メソッドで定義している処理は、メニュークラスやパネルクラスで定義する ```draw()``` メソッドと同じように、 ```self.layout``` を通して行います。

利用可能なアイコンの識別子一覧は、 ```bpy.types.UILayout.bl_rna.functions['prop'].parameters['icon'].enum_items.keys()``` により取得することが可能です。
取得したアイコンの識別子を、 ```row.label()``` 関数の引数 ```icon``` に指定することで、アイコンを表示することができます。
また本節のサンプルは今後アドオンを作る人のために、アイコンと識別子がどのように対応しているかわかるように、引数 ```text``` に識別子を代入してアイコンと一緒に表示しています。
見やすさを考慮して、一行に表示可能なアイコンの数をオプションから指定することができるようにしています。ぜひ活用してください。

最後に、 ```ShowAllIcons``` のボタンを配置する処理は、以下のようになります。

```python
# プロパティのUIをカスタマイズする＋アイコン一覧を表示する
layout.label(text="プロパティのUIをカスタマイズする")
layout.operator(ShowAllIcons.bl_idname)
```

### メニューへ項目を追加する順番を制御する

[2-1節](01_Basic_of_Add-on_Development.md) では、 ```bpy.types.INFO_MT_mesh_add.append()``` 関数を用いてメニューの末尾へ項目を追加していました。

本節のサンプルでは、 ```bpy.types.VIEW3D_MT_object.prepend()``` 関数を用いてメニューの先頭へ項目を追加しています。

```python
# 項目をメニューの先頭に追加
bpy.types.VIEW3D_MT_object.append(menu_fn_1)
# 項目をメニューの末尾に追加
bpy.types.VIEW3D_MT_object.prepend(menu_fn_2)
```


## まとめ




<div id="point"></div>

### ポイント

<div id="point_item"></div>

* Blender はボタンやメニューなどの UI 部品を追加するための API を用意しているため、 API を活用することで独自の UI を構築できる
* ツール・シェルフのタブを追加するためには、 ```bpy.types.Panel``` クラスを継承したパネルクラスを作成し、メンバ変数 ```bl_region_type``` に ```TOOLS``` を指定する必要がある
* 特定の状況下でのみメニューを表示したり、処理を実行させたりするように制限をかける場合は ```poll()``` メソッドを使用する
* パネルクラスのメンバ変数 ```bl_context``` を宣言することで、描画するコンテキストを指定することができる
* ツール・シェルフに追加したタブのヘッダーの UI を変更するためには、パネルクラスに ```draw_header()``` メソッドを定義する
* ツール・シェルフに追加したタブのメニューの UI を変更するためには、パネルクラスに ```draw()``` メソッドを定義する
