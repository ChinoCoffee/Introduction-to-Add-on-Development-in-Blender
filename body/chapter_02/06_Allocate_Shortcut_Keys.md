<div id="sect_title_img_2_6"></div>

<div id="sect_title_text"></div>

# ショートカットキーを割り当てる

<div id="preface"></div>

###### Blenderの機能やアドオンにはショートカットキーを割り当てることで、頻繁に使う機能を素早く行えるようにしているものがあります。例えば、*3Dビュー* エリアのメニュー *オブジェクト* > *トランスフォーム* > *移動* で実行される機能にはGキーが割り当てられてます。Blenderの機能と同様、個人で作成した機能にもショートカットキーを割り当てることができます。本節では [2-4節](04_Sample_4_Replicate_object_1.md) を改良し、自作したアドオンの機能にショートカットキーを割り当てる方法を紹介します。

## 作成するアドオンの仕様

* [2-4節](04_Sample_4_Replicate_object_1.md) で作成したサンプルを改良し、 *3Dビュー* エリアのメニュー *オブジェクト* > *選択オブジェクトの複製* にショートカットキー（ctrl + alt + R）を割り当てる

## アドオンを作成する

[1-4節](../chapter_01/04_Install_own_Add-on.md) を参考にして以下のソースコードを *テキスト・エディタ* に入力し、 ```sample_6.py``` という名前で保存してください。

[import](../../sample/src/chapter_02/sample_6.py)

## アドオンを実行する

### アドオンを有効化する

[1-4節](../chapter_01/04_Install_own_Add-on.md) を参考に、作成したアドオンを有効化すると *コンソール* に以下の文字列が出力されます。

```sh
サンプル6: アドオン「サンプル6」が有効化されました。
```

### アドオンを使ってみる

*3Dビュー* エリア上でオブジェクトを選択し、 *ctrl* + *alt* + *R* キーを押してください。
*オブジェクト* > *選択オブジェクトの複製* を実行した時と同じく、選択されたオブジェクトが複製されたはずです。
以下の図は、 *Cube* を選択して上記のキーを押した時のものです。

![オブジェクトの複複](https://dl.dropboxusercontent.com/s/sqzwdwfgs245mp6/use_add-on_1.png "オブジェクトの複製")

### アドオンを無効化する

[1-4節](../chapter_01/04_Install_own_Add-on.md) を参考に、アドオンを無効化すると *コンソール* に以下の文字列が出力されます。

```sh
サンプル6: アドオン「サンプル6」が無効化されました。
```

## ソースコードの解説

### ショートカットキーの割り当て

ショートカットキーの割り当ては、 ```register_shortcut()``` 関数で行います。

```python
def register_shortcut():
    wm = bpy.context.window_manager
    kc = wm.keyconfigs.addon
    if kc:
        # 3Dビューのショートカットキーとして登録
        km = kc.keymaps.new(name="3D View", space_type="VIEW_3D")
        # ショートカットキーの登録
        kmi = km.keymap_items.new(
            idname=ReplicateObject.bl_idname,
            type="R",
            value="PRESS",
            shift=False,
            ctrl=True,
            alt=True)
        # ショートカットキー一覧に登録
        addon_keymaps.append((km, kmi))
```

```bpy.context.window_manager.keyconfigs.addon.keymaps``` はアドオンに割り当てられているキーマップです。
```keymaps.new()``` 関数を実行することで、新たにキーマップを割り当てることができます。
今回は ```keymaps.new()``` に以下に示す引数を指定してキーマップを割り当てています。

|引数|値の意味|
|---|---|
|```name```|キーマップ名|
|```space_type```|キーマップを割り当てるエリア名|

キーマップを割り当て後は、 ```km.keymap_items.new()``` 関数により新しく割り当てたキーマップにショートカットキーを登録していきます。
```km.keymap_items.new()``` 関数に指定する引数は以下の通りです。

|引数|値の意味|
|---|---|
|```idname```|イベント発生時に実行する処理を記載した、オペレータクラスの ```bl_idname``` |
|```type```|イベントを発生させるキーボードのキー|
|```value```|イベント発生の条件値|
|```shift```|イベント発生のためにshiftキーが押されている必要がある時は ```True```|
|```ctrl```|イベント発生のためにctrlキーが押されている必要がある時は ```True```|
|```alt```|イベント発生のためにaltキーが押されている必要がある時は ```True```|

今回は *shift + ctrl + R* が押された時にイベントを発生させ、オブジェクトの複製の処理を実行するように引数を設定しています。
イベントが発生時に ```idname``` に指定した処理を実行しますが、 ```value``` には例えば以下のようなイベント発生の条件値を指定できます。

|イベント値|値の意味|
|---|---|
|```PRESS```|ボタンを押した時にイベントを発生させる|
|```RELEASE```|ボタンを話した時にイベントを発生させる|
|```ANY```|ボタンの状態に何かしら変更のあった時にイベントを発生させる|
|```NOTHING```|イベントを発生させない|

最後に、割り当てたキーマップとショートカットキーのペアをグローバル変数 ```addon_keymaps``` に保存します。
この変数はアドオン無効化時に、割り当ててたショートカットを削除するために必要になります。

### ショートカットキーの割り当て解除

アドオン内で登録したショートカットキーは、アドオン無効化時に割り当てを解除する必要があります。
ショートカットキーの割り当て解除は、 ```unregister_shortcut()``` 関数で行います。

```python
def unregister_shortcut():
    for km, kmi in addon_keymaps:
        # ショートカットキーの登録解除
        km.keymap_items.remove(kmi)
    # ショートカットキー一覧をクリア
    addon_keymaps.clear()
```

変数 ```addon_keymaps``` に保存しておいたキーマップを用いて、 ```keymap_items.remove()``` によりショートカットキーのペアを削除しています。
最後に、キーマップとショートカットキーのペアを保存しておいた ```addon_keymaps``` をクリアします。

### 割り当てるショートカットキー

Blenderでは既にたくさんの機能にショートカットキーが割当てられているため、単一のキーの中から何も割当たっていないキーを探すのが意外と大変です。
そのような時は、ctrlキーやshiftキー、altキーとの組み合わせたショートカットキーを検討しましょう。
これらのキーと組み合わせることで、すでに割り当てられているキーと被る可能性が低くなるため、意外と簡単に空いているキーを見つけることができると思います。
今回のサンプルでも、ctrlキーやaltキーを組み合わせたショートカットキーを登録しています。

また、割り当てるショートカットキーは、ショートカットキーを割り当てる機能を類推できるようなものにしましょう。
今回ショートカットキーを割り当てた機能であるオブジェクトの複製は、英訳するとReplicate Objectになるため、英訳の頭文字を取ってRキーを割り当てています。

## まとめ

[2-4節](04_Sample_4_Replicate_object_1.md) を改造し、*3Dビュー* エリアのメニュー *オブジェクト* > *選択オブジェクトの複製* にショートカットキーを割り当て、ショートカットキーから実行できるようにしました。
ショートカットキーを機能に割り当てることで、ユーザが機能を素早く利用できるようになります。

頻繁に使う機能に対してショートカットキーを割り当てることは、アドオンの利便性の改善に繋がる可能性があります。しかしその反面、ショートカットキーに設定できる組み合わせには限りがあるため、ショートカットキーを乱用して利用可能なショートカットキーを減らしてしまうのはよくありません。

アドオンを様々な人に使ってもらうことを考えている場合、ショートカットキーを設定することでユーザにとって利便性を向上させるものであるか考えてから設定するようにしましょう。個人的に利用するアドオンでない限り、試しにショートカットキーを割り当てたとか、とりあえず割り当てとけば良い程度の判断でショートカットキーを設定すべきではありません。

<div id="point"></div>

### ポイント

<div id="point_item"></div>

* エリアごとのキーマップを割り当て後にショートカットキーを割り当てることで、機能にショートカットキーを割り当てることができる
* キーマップは、 ```bpy.context.window_manager.keyconfigs.addon.keymaps.new()``` 関数を実行することにより割り当てることができる
* ショートカットキーは、 キーマップ ```km``` に対して ```km.keymap_items.new()``` 関数を実行することにより割り当てることができる
* 割り当てたショートカットキーは、アドオン無効化時に割り当てを解除する必要がある
