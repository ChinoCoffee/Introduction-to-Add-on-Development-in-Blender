# 2-4. サンプル4: オブジェクトを複製する1

## 作成するアドオンの仕様

* **3Dビュー** のメニュー **オブジェクト** に *選択オブジェクトの複製* を追加する
* 追加した *選択オブジェクトの複製* を実行すると、選択中のオブジェクトを複製する
* 複製したオブジェクトの配置先は、 **ツール・シェルフ** から *3Dカーソル* または *原点* 、3Dビュー上に配置されているオブジェクトから選択可能にする
* 複製したオブジェクトのサイズ・回転角度・配置場所からのオフセットを **ツール・シェルフ** から選択可能にする

## アドオンを作成する

以下のソースコードを、 [1.4節](../chapter_01/04_Install_own_Add-on.md)を参考にして **テキスト・エディタ** に入力し、
**sample_4.py** という名前で保存してください。

{% include "../../sample/src/chapter_02/sample_4.py" %}

## アドオンを実行する

### アドオンを有効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、作成したアドオンを有効化すると **コンソール** に以下の文字列が出力されます。

```sh
サンプル 4: アドオン「サンプル4」が有効化されました。
```

### アドオンの機能を使ってみる

アドオンを有効化したら、 *3Dビュー* のメニューに *オブジェクト* > *選択オブジェクトの複製* が追加されていることを確認します。
Blender起動直後に生成される *Cube* を選択し、追加されたメニューを実行してみましょう。
実行すると、*コンソール・ウィンドウ* に以下のメッセージが表示されて選択したCubeが複製されるはずです。

```sh
サンプル 4: 「Cube」を複製しました。
```

＊＊図を追加＊＊

*3Dビュー* の *ツール・シェルフ* からオプションをいろいろ変更してみましょう。
今回のサンプルでは、以下に示すオプションを変更可能です。

|オプション名|操作への影響|
|---|---|
|*配置位置*|*3Dカーソル* : 3Dカーソルの位置に複製オブジェクトを配置します <br> *原点* : 3Dビューの原点に複製オブジェクトを配置します <br> *オブジェクト名* : 選択したオブジェクトに複製オブジェクトを配置します|
|*拡大率*|複製したオブジェクトについて、複製元のオブジェクトに対する拡大率を設定します|
|*回転角度*|複製したオブジェクトについて、複製元オブジェクトからの回転角度の差分をオイラー角で設定します|
|*オフセット*|複製したオブジェクトについて、配置位置からのオフセット位置を指定します|

＊＊図を追加＊＊

### アドオンを無効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、有効化したアドオンを無効化すると **コンソール** に以下の文字列が出力されます。

```sh
サンプル 4: アドオン「サンプル 4」が無効化されました。
```

## ソースコードの解説

今回作成したアドオンは、[2-3節](03_Sample_3_Scaling_object_2.md) の応用となります。
ここでは [2-3節](03_Sample_3_Scaling_object_2.md) にて解説できていなかった点について解説します。

### EnumPropertyの選択項目を動的に追加

```EnumProperty``` を用いると、セレクトボックスによりユーザが値を選択することが可能なUIを作成することできます。
```EnumProperty``` を用いてセレクトボックスの選択項目を設定するためには、```EnumProperty``` クラス作成時に引数 ```items``` に選択項目のリストを渡す必要があります。
まず最初に、今回のサンプルで *3Dカーソル* と *原点* のみ追加するだけのコードを以下に示します。

```py:sample_4_part1_alt.py

location_list = [
    ('3D_CURSOR', "3Dカーソル", "3Dカーソル上に配置します"),
    ('ORIGIN', "原点", "原点に配置します")]

location = EnumProperty(
    name = "配置位置",
    description = "複製したオブジェクトの配置位置",
    items = location_list
)
```

リストに渡す要素は、以下の要素からなるタプルを渡します。

|||
|---|---|
|第1要素|識別子 <br> 項目が選択時に変数に設定される値|
|第2要素|セレクトボックスに表示される項目名|
|第3要素|セレクトボックスに表示される項目の説明|

ただしこれでセレクトボックスを作ることはできましたが、複製オブジェクトを3Dビュー上に配置されているオブジェクトへ配置することができません。
3Dビュー上に配置されているオブジェクトは、アドオンを実行した状況に応じて変化するからです。
例えば、*オブジェクト* > *選択オブジェクトの複製* 実行後に *オブジェクト* > *選択オブジェクトの複製* を再度実行した場合、最初に複製されたオブジェクトも配置先として選べる必要があります。

この問題に対し、紹介したサンプルでは以下のように ```EnumProperty``` により作ることのできるセレクトボックスの選択項目を動的に追加するようにしています。

```py:sample_4_part1.py
# EnumPropertyで表示したい項目リストを作成する関数
def location_list_fn(scene, context):
    items = [
        ('3D_CURSOR', "3Dカーソル", "3Dカーソル上に配置します"),
        ('ORIGIN', "原点", "原点に配置します")]
    items.extend([('OBJ_' + o.name, o.name, "オブジェクトに配置します") for o in bpy.data.objects])

    return items

# 選択したオブジェクトを複製するアドオン
class ReplicateObject(bpy.types.Operator):

    bl_idname = "object.replicate_object"
    bl_label = "選択オブジェクトの複製"
    bl_description = "選択中のオブジェクトを複製します"
    bl_options = {'REGISTER', 'UNDO'}

    location = EnumProperty(
        name = "配置位置",
        description = "複製したオブジェクトの配置位置",
        items = location_list_fn
    )
```

サンプルでは ```EnumProperty``` の ```items``` にリストの代わりに ```location_list_fn()``` 関数を渡しています。
```location_list_fn()``` は、3Dカーソルと原点についてセレクトボックスの選択項目リストを作成した後、 ```items.extend([('OBJ_' + o.name, o.name, "オブジェクトに配置します") for o in bpy.data.objects])``` により、3Dビュー上に置かれている全オブジェクトについてセレクトボックスの選択項目を作成し、リストに追加しています。
最後に ```location_list_fn()``` は作成したリストを返しています。
このように、セレクトボックスの選択項目向けのリストを返す関数を ```EnumProperty``` の ```items``` に指定することで ```EnumProperty``` の選択項目を動的に追加することができます。


## まとめ

### ポイント

*
