<div id="sect_title_img_2_1"></div>

<div id="sect_title_text"></div>

# アドオン開発の基礎

<div id="preface"></div>

###### [1-4節](../chapter_01/04_Install_own_Add-on.md) ではアドオンのソースコードを作成し、アドオンをインストール＆アンインストールしましたが、ソースコードの解説を一切行っていないため今の段階ではよくわからない状態かと思います。本節ではより実用的なアドオンのサンプルを紹介し、そのソースコードを解説します。


## 作成するアドオンの仕様

[1-4節](../chapter_01/01_Sample_1_Create_object_from_Add-on.md) で紹介したアドオンは、アドオンの有効化・無効化時にコンソールへメッセージを出力する機能だけを持つアドオンでした。
これではさすがにアドオンと呼ぶのには寂しい気がしますので、今回は前回より実用的な機能を持ったアドオンを作ります。

最初に、今回作成するアドオンの仕様を決めます。
アドオンのソースコードを用いた初めての解説になるので、本書で紹介するサンプルの仕様は以下のようにしました。

* *3Dビュー* エリアのメニューバーに *追加* > *メッシュ* > *球* を追加
* 追加したメニューを実行すると、 *3Dビュー* エリアのメニューバーの *追加* > *メッシュ* > *ICO球* を実行した時と同等の効果を得る

### Blender標準機能によるICO球作成

*3Dビュー* エリアのメニューバーの *追加* > *メッシュ* > *ICO球* を実行した時の動作を確認します。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|1|*3Dビュー* エリアのメニューバーから *追加* > *メッシュ* > *ICO球* を実行します。|![ICO球作成 手順1](https://dl.dropboxusercontent.com/s/z760a6xqpztgnhb/blender_generate_ico-sphere_1.png "ICO球作成 手順1")|
|---|---|---|

<div id="column"></div>

実際にアドオンを開発する時も、仕様を最初に明確化しておくことが重要です。
アドオンの仕様を最初に決めることにより、アドオンで何を実現すればよいか、実現にあたり何が課題となりそうかを整理することができます。
仕様をなんらかの形で残しても良いかもしれません。

<div id="process_sep"></div>

---

<div id="process"></div>

|2|3Dカーソルを中心としたICO球が作成されます。|![ICO球作成 手順2](https://dl.dropboxusercontent.com/s/4a1k4c68k8eteuv/blender_generate_ico-sphere_2.png "ICO球作成 手順2")|
|---|---|---|

<div id="process_start_end"></div>

---


## アドオンを作成する

先ほど決めた仕様を満たすようにアドオンを作成します。
ソースコードの解説は後ほど行いますので、 [1-4節](../chapter_01/04_Install_own_Add-on.md) を参考にして以下のソースコードを入力し、 ```sample_1.py``` という名前で保存してください。

[import](../../sample/src/chapter_02/sample_1.py)

## アドオンを実行する

アドオンの動作を確認してから解説した方が理解が深まると思いますので、ソースコードの解説に入る前に作成したアドオンを使ってみます。

### アドオンを有効化する

[1-4節](../chapter_01/04_Install_own_Add-on.md) を参考に、作成したアドオンを有効化します。
アドオンを有効化すると、コンソールに以下の文字列が出力されるはずです。

```shell-session
サンプル 1: アドオン「サンプル1」が有効化されました。
```

アドオン有効化後、 *3Dビュー* エリアのメニューバーに *追加* > *メッシュ* > *球* が追加されていることを確認します。

![アドオンの実行 手順1](https://dl.dropboxusercontent.com/s/insl725bg08g8j4/blender_use_add-on_1.png "アドオンの実行 手順1")

### アドオンの機能を使ってみる

以下の手順に従って、アドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|1|追加されたメニュー *追加* > *メッシュ* > *球* を実行します。すると、3Dカーソルを中心としたICO球が作成されます。|![アドオンの実行 手順2](https://dl.dropboxusercontent.com/s/ek7n05o59hyhlp3/blender_use_add-on_2.png "アドオンの実行 手順2")|
|---|---|---|

さらに、コンソールには以下の文字列が出力されます。

```shell-session
サンプル 1: 3DビューにICO球を生成しました。
```

<div id="process_start_end"></div>

---


### アドオンを無効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md) を参考に、アドオンを無効化します。
アドオンが無効化されると、コンソールに以下の文字列が出力されます。

```shell-session
サンプル 1: アドオン「サンプル 1」が無効化されました。
```

<div id="column"></div>

ここまで期待した動作になっているでしょうか。
もし期待した動作にならずエラーが出てしまっている場合は、ソースコードに入力した内容が正しいか確認しましょう。
特にPythonではスペースやタブが混ざっていたり、スペースやタブの数が合っていなかったりする場合にエラーになるケースが多いので、空白には特に注意してください。

## ソースコードの解説

アドオンの動作が確認できたところで、作成したアドオンのソースコードを解説します。

### bpyモジュールのインポート

Blenderのアドオンを開発するためには、 ```bpy``` モジュールと呼ばれるBlenderが提供しているAPIをまとめたモジュールをインポートし、APIを利用できるようにする必要があります。
以下のソースコードにより、bpyモジュールをインポートすることができます。

```python
import bpy   # アドオン開発者に対して用意しているAPIを利用する
```

### bl_info変数の作成

作成したソースコードがBlenderのアドオンであることをBlender本体に認識させるためには、 ```bl_info``` と呼ばれる変数を作成する必要があります。


```python
# アドオンに関する情報を保持する、bl_info変数
bl_info = {
	"name": "サンプル 1: オブジェクトを生成するアドオン",
	"author": "Nutti",
	"version": (1, 0),
	"blender": (2, 75, 0),
	"location": "3Dビュー > 追加 > メッシュ",
	"description": "オブジェクトを生成するサンプルアドオン",
	"warning": "",
	"support": "TESTING",
	"wiki_url": "",
	"tracker_url": "",
	"category": "Object"
}
```

```bl_info``` はディクショナリ型の変数で以下のようなキーと値を設定する必要があります。

|キー|値の型|値の説明|
|---|---|---|
|name|文字列|アドオンの名前|
|author|文字列|アドオンの作者|
|version|タプル|アドオンのバージョン|
|blender|タプル|アドオンが動作するBlender本体の"最古"のバージョン<br>ここに指定されたバージョンより古いBlenderでアドオンをインストールすると警告が出る|
|location|文字列|アドオンが提供する機能がある場所|
|description|文字列|アドオンの説明文|
|warning|文字列|アドオン使用時の注意点、バグ情報等|
|support|文字列|アドオンのサポートレベル|
|wiki_url|文字列|アドオンに関連する情報が得られるサイトのURL（ドキュメントサイト）|
|tracker_url|文字列|アドオンのサポートサイトのURL|
|category|文字列|アドオンのカテゴリ|

それぞれのキーに対して設定した値について、Blenderへの反映箇所を説明します。

#### ユーザ設定ウィンドウ


アドオンを有効化/無効化する時に利用する *ユーザ設定* ウィンドウに表示される情報は、以下の ```bl_info``` 変数に指定された値に基づいています。

* ```name```
* ```author```
* ```version```
* ```location```
* ```description```
* ```warning```
* ```wiki_url```
* ```tracker_url```

今回作成したアドオンについて、これらの情報がどのように表示されるか確認します。
以下の図では、 ```bl_info``` 変数に指定された値と表示内容の対応関係を示しています。
```warning```, ```wiki_url```, ```tracker_url``` については、本節のサンプルでは未設定のため表示されていません。

![bl_info 解説1](https://dl.dropboxusercontent.com/s/ko8lslcvcw84ras/blender_bl-info_1.png "bl_info 解説1")

作成したサンプルは ```warning```, ```wiki_url```, ```tracker_url``` を設定していませんが、もし値を設定した場合に *ユーザ設定* ウィンドウへどのように反映されるか見てみます。
ソースコード中の ```bl_info``` を以下のように書き換えます。

```python
# アドオンに関する情報を保持する、bl_info変数
bl_info = {
	"name": "サンプル 1: オブジェクトを生成するアドオン",
	"author": "Nutti",
	"version": (1, 0),
	"blender": (2, 75, 0),
	"location": "3Dビュー > 追加 > メッシュ",
	"description": "オブジェクトを生成するサンプルアドオン",
	"warning": "本アドオンはサンプルです",
	"support": "TESTING",
	"wiki_url": "https://www.gitbook.com/book/nutti/introduction-to-add-on-development-in-blender/",
	"tracker_url": "https://github.com/nutti/Introduction-to-Add-on-Development-in-Blender",
	"category": "Object"
}
```

ソースコードを書き換えてアドオンを有効化すると、 *ユーザ設定* ウィンドウのアドオン情報にボタンと警告マークが表示されます。

![bl_info 解説2](https://dl.dropboxusercontent.com/s/pxe76rmhdanmmpw/blender_bl-info_2.png "bl_info 解説2")

*ドキュメント編集* ボタンをクリックすると、 ```wiki_url``` に指定したURLが開きます。
アドオンのドキュメントや本アドオンの最新情報が得られるサイトのURLを ```wiki_url``` に設定するように設定します。
本節のサンプルでは、本書のWebページ版が公開されているURLを設定しました。

*バグを報告* をクリックすると、 ```tracker_url``` に指定したURLが開きます。
アドオンのバグを報告するサイトをお持ちの方やユーザからのフィードバックを得たい方は、設定しておくと良いかと思います。
今回は本書のソースコードを公開しているサイトのURLを設定しました。

以下では具体的に指定する内容について示します。

##### name

アドオン名を指定します。
基本的にアドオン名は自由に決めても良いですが、アドオンの機能に関連した名前をつけるようにしましょう。
また、ユーザがアドオン名とアドオンのソースコードを対応付けやすくするため、アドオン名とユーザに提供するソースコードのファイル名は似せましょう。

##### author

アドオンの開発者を指定します。
複数の開発者がアドオンを開発した場合、アドオン作成への貢献度順に名前を指定します。
例えば ```Hoge``` がアドオンのメイン部を作成し、その後 ```Piyo``` がアドオンを修正した場合は、以下のように指定します。

```python
"author": "Hoge, Piyo"
```

##### version

アドオンのバージョンを指定します。
フォーマットは以下の通りです。

```(メジャーバージョン, マイナーバージョン)```

正式リリース前はメジャーバージョンを ```0``` とし、マイナーバージョンをアップデートの度に増やしていきます。
正式リリース時にはメジャーバージョンを ```1``` とし、以降UIなどに影響する大きな修正が入る場合に増やします。
機能追加などの細かい修正時には、正式リリース前と同様にマイナーバージョンを増やしていきます。
なおメジャーバージョンを増やした時は、マイナーバージョンを ```0``` に戻します。

例えば、正式リリース直後に初めて細かい修正を加えた場合は、 ```(1, 1)``` となります。


##### location

アドオンの機能を使うためのUIが存在する場所を指定します。
例えば *3Dビュー* エリアの *追加* > *メッシュ* に追加する場合は、以下のように記載します。

```3Dビュー > 追加 > メッシュ```


<div id="column"></div>

もし多くの場所にUIが追加される場合は、 ```"See Add-ons Preferences"``` などと記載しAdd-ons Preferencesに記載する方法もありますが、ここでは省略します。


##### description

アドオンがどのような機能を持つかを記載します。
表示できるスペースが非常に少ないことから簡潔に記載することを目指すべきですが、もしアドオンが多くの機能を持つ場合など、記載内容が長くなりそうなら ```location``` と同様 ```"See Add-ons Preferences"``` などと記載しAdd-ons Preferencesに記載すると良いと思います。

##### warning

本項目を指定すると、警告アイコンと ```warning``` に指定した文字列が表示されるようになります。
本項目はアドオンが正式リリース前のテスト中であることを示す場合や、機能の一部に不具合がある場合に指定します。

##### wiki_url

アドオンのチュートリアルなど、アドオンに関するドキュメントが存在するWebページのURLを指定します。
Blender公式のWikiページにアドオンのドキュメントを公開しているのであれば、Blender公式のWikiページを指定することができます。

<div id="webpage"></div>

|Blender Wiki (Blender Add-ons Catalog)|
|---|
|http://wiki.blender.org/index.php/Extensions:2.6/Py/Scripts|
|![Blender Wiki (Blender Add-ons Catalog)](https://dl.dropboxusercontent.com/s/eqhblsox8zibbh8/blender_add-on_catalog.png "Blender Wiki (Blender Add-ons Catalog)")|


##### tracker_url

アドオンに不具合があった際にユーザが報告するためのWebページのURLを指定します。
サポートレベルがOfficialまたはContribであればD.B.Oのバグ報告ページを指定することになっていますが、個別にサポートページを持つ場合はそのサポートページを指定しても良いです。

<div id="webpage"></div>

|developer.blender.org (Report a bug)|
|---|
|https://developer.blender.org/maniphest/task/create/?project=3&type=Bug|
|![developer.blender.org (Report a bug)](https://dl.dropboxusercontent.com/s/sr9drckwomr17ew/dbo_report_add-on_bug.png "developer.blender.org (Report a bug)")|


#### アドオンのサポート情報

以下の値を設定することにより、アドオンのサポート情報を指定できます。

##### blender

アドオンが動作する最古のバージョンを以下の形式で指定します。

```(メジャーバージョン, マイナーバージョン, 0)```

基本的には、アドオンを開発したBlenderのバージョンを指定しておけば良いと思います。
アドオンを更新する時に使用したBlenderのバージョンが異なる場合においても ```blender``` を修正することも忘れないようにしましょう。

Blenderのバージョンが2.70であれば、 ```blender``` に指定する値は ```(2, 70, 0)``` となります。

<div id="column"></div>

```version``` に指定するタプル値の最後の要素は基本的に ```0``` を指定します。
ちなみに、タプル値の最後の要素はBlenderのサブバージョンを指定することになっています。
しかし、Blenderのサブバージョンはアドオン内部では基本的に利用しないため、 ```version``` に ```0``` を指定するのが慣習となっています。


なお、指定したバージョンよりも古いバージョンのBlenderでアドオンを有効化すると警告メッセージが表示されます。

実際、どのような警告メッセージが表示されるか確認してみましょう。
```blender``` に ```(2, 76, 0)``` を指定してアドオンを有効化すると、図のように警告メッセージが表示されます。

![bl_info 解説3](https://dl.dropboxusercontent.com/s/qork1jkrh9flakt/blender_bl-info_3.png "bl_info 解説3")

<div id="column"></div>

アドオンが動作するバージョンを指定すると説明しましたが、実際は警告が表示されるだけで、警告を無視して使うことができてしまいます。
このため、 ```blender``` に指定したバージョンよりも古いバージョンのBlenderでも、アドオンを使える可能性があります。


##### support

アドオンのサポートレベルを以下の3つから選択します。
[1-2節](../chapter_01/02_Use_Blender_Add-on.md) で説明したアドオンのサポートレベルを参考に設定してください。

|設定値|ユーザ設定ウィンドウ上の表示|値の意味|
|---|---|---|
|```OFFICIAL```|公式|Blenderが公式にサポートするアドオンです。サポートレベルが *Release* のアドオンに対して設定します。|
|```COMMUNITY```|コミュニティ|Blenderが公式にサポートしないアドオンです。サポートレベルが *Contrib* または *External* のアドオンに対して設定します。|
|```TESTING```|テスト中|テスト中のアドオンに対して設定します。機能が不完全な場合や、アドオンがテスト中で不安定な状態にある場合に設定します。|

*ユーザ設定* ウィンドウでは、サポートレベルに応じてインストールされたアドオンをフィルタリングして表示することが可能です。
例えば *テスト中* のボタンのみ選択状態にすることで、 ```support``` に ```TESTING``` が設定されたアドオンのみ表示することができます。

本書で紹介する全てのサンプルのアドオンは ```support``` に ```TESTING``` を設定されています。
*テスト中* のボタンのみ選択することで、サンプルのアドオンをすぐに見つけることができます。

![bl_info 解説4](https://dl.dropboxusercontent.com/s/38x9jafp3vzspyu/blender_bl-info_4.png "bl_info 解説4")

##### category

アドオンが属するカテゴリを指定します。
アドオンは機能の種類によって、カテゴリとして分類されます。
以下の図に示すように、カテゴリ一覧は *ユーザ設定* ウィンドウの *カテゴリー* から確認できます。
アドオンのカテゴリは英語で指定する必要があるため、Blenderを日本語化している方は一度英語に戻してカテゴリの正式名称を確認しましょう。

![bl_info 解説5](https://dl.dropboxusercontent.com/s/kbukte47nas0i5r/blender_bl-info_5.png "bl_info 解説5")

既存のカテゴリに分類できない場合は、新たなカテゴリを作ることもできます。
```category``` に ```Sample``` を指定すると、新たなカテゴリとして ```Sample``` が追加されていることがわかります。

<div id="column"></div>

アドオン開発者は新しいカテゴリを自由に追加することができますが、可能な限り既存のカテゴリに含めるようにし、基本的に新しいカテゴリは作らないようにしましょう。実際、既存のカテゴリだけでも十分カテゴリとしては網羅できているはずですので、新たにカテゴリを作る必要がないと思います。

![bl_info 解説6](https://dl.dropboxusercontent.com/s/7tjnz7m5w4go17d/blender_bl-info_6.png "bl_info 解説6")

<div class="column"></div>

bl_infoは必ずしも必要な情報ではなく、あくまでアドオンの情報をユーザ設定ウィンドウに表示するために利用する変数です。  
このためbl_infoがなくても、ソースコードを実行してアドオンの機能を利用することができます。
しかしbl_infoを設定しないとユーザ設定ウィンドウにアドオンが表示されず、コンソールに警告メッセージが表示されてしまいます。  
Blender公式のアドオン開発のガイドラインにも、アドオン開発時はbl_infoを設定するように書かれていますので、特別な理由がない限りは設定するようにしましょう。


### オペレーション用クラスの作成

アドオンからBlenderに対して何かしらの操作するためには、 **オペレーション用クラスを作成し具体的な機能の処理を定義する** 必要があります。
オペレーション用クラスは、bpyモジュールが提供するクラスである ```bpy.types.Operator``` を継承して作成します。
以下では、オペレーション用クラスの作成方法を紹介します。

オペレーション用クラスのメンバ変数の宣言例を以下に示します。

```python
# オブジェクト（ICO球）を生成するオペレーション
class CreateObject(bpy.types.Operator):

	bl_idname = "object.create_object"
	bl_label = "球"
	bl_description = "ICO球を追加します"
	bl_options = {'REGISTER', 'UNDO'}
```

オペレーション用クラスには、以下のようなメンバ変数を含める必要があります。

|メンバ変数|型|値の説明|
|---|---|---|
|```bl_idname```|文字列|Blender内部で使用するID|
|```bl_label```|文字列|メニュー登録時に、メニュー項目に表示する文字列|
|```bl_description```|文字列|メニュー登録時に、メニュー項目に表示する説明文|
|```bl_options```|ディクショナリ|処理の属性|

```bl_idname``` にはBlender内部で使用するIDを設定します。
```bl_idname``` は自由に決めても良いですが、 ```<アドオンのカテゴリ>.<任意の文字列>``` のように指定し、Blender内で唯一の文字列である必要があります。
今回は、作成するアドオンのカテゴリが ```OBJECT``` であることから、IDを ```object.create_object``` としました。  
```bl_options``` には、オペレーション用クラスの処理の属性を、キーのみ指定したディクショナリ型で指定します。
今回はメニューへ登録するための ```REGISTER``` と、処理中のエラー発生時に処理実行前の状態へ戻すことを可能にするための ```UNDO``` を指定しました。

```bl_idname```　、 ```bl_label``` 、 ```bl_description``` に指定した内容は、以下のように追加したメニュー項目から確認することができます。

![オペレーション 解説7](https://dl.dropboxusercontent.com/s/nd2gve5namkfn1l/blender_operation_1.png "オペレーション 解説1")

続いて、メニューを実行した時に呼ばれる関数を作成します。

```python
  # メニューを実行した時に呼ばれる関数
	def execute(self, context):
		bpy.ops.mesh.primitive_ico_sphere_add()
		print("サンプル 1: 3DビューにICO球を生成しました。")

		return {'FINISHED'}
```

メニューを実行した時には ```exexute()``` メソッドが呼ばれます。
このため、 ```exexute()``` メソッドにはメニューを実行した時の処理を記述します。

```execute()``` メソッドが呼ばれると、以下の引数がBlender本体から渡されてきます。
今回はこれらの引数を利用しないため、特に意識する必要はありません。

|引数|型|値の説明|
|---|---|---|
|```self```|呼ばれた ```execute()``` メソッドを定義しているクラス|オペレーション用クラスのインスタンス|
|```context```|```bpy_types.Context```|```exexute()``` メソッド実行時のコンテキスト|

```execute()``` メソッドの中身を見てみます。
最初に、 ```bpy.ops.mesh.primitive_ico_sphere_add()``` 関数を呼んでいます。
これはBlenderが提供しているAPIの1つで、 *3Dビュー* エリアにICO球を生成します。
この関数は複数の引数を渡すことができますが、今回は引数を1つも指定していないため、3Dカーソルの位置にICO球が生成されます。
```bpy.ops.mesh.primitive_ico_sphere_add()``` は引数として例えば以下のようなものを渡すことができます。

|引数|型|値の説明|
|---|---|---|
|```size```|浮動小数点数|生成するICO球のサイズ|
|```location```|タプル|生成時のICO球の座標|
|```rotation```|タプル|生成時のICO球の回転角|

先ほど示したソースコードを改造し、```bpy.ops.mesh.primitive_ico_sphere_add()``` に引数を指定して実行してみましょう。
ICO球生成時のサイズが2.0倍、座標が(x, y, z) = (5.0, -5.0, 0.0)、回転角（ラジアン）が(x, y, z) = (0.79, 0.0, 1.57)のICO球を作成するようにします。
```execute()``` メソッドを以下のように書き換えてください。

```python
  # メニューを実行した時に呼ばれる関数
	def execute(self, context):
		bpy.ops.mesh.primitive_ico_sphere_add(size=2.0, location=(5.0, -5.0, 0.0), rotation=(0.79, 0.0, 1.57))
		print("サンプル 1: 3DビューにICO球を生成しました。")

		return {'FINISHED'}
```

この状態でアドオンを有効化して、 *3Dビュー* エリアのメニュから *追加* > *メッシュ* > *球* を実行すると、以下のように指定した引数に応じたICO球を生成します。

![オペレーション 解説2](https://dl.dropboxusercontent.com/s/a6qe1qaytr33dri/blender_operation_2.png "オペレーション 解説2")

<div id="column"></div>

```bpy.ops.mesh.primitive_ico_sphere_add()``` がICO球を作成する関数であると書きましたが、どのようにしてこの関数がICO球を作成する関数であることを知ることができたのでしょうか？  
[4-1節](../chapter_04/01_Research_official_Blender_API_for_Add-on.md)で紹介する、BlenderのAPIリファレンスから探しても良いですが、本APIについてはもっと簡単に調べる方法があります。  
Blenderではメニューやボタンをマウスオーバーすることで実行される関数を表示することができるため、 *3Dビュー* エリアのメニューバーの *追加* > *メッシュ* > *ICO球* にマウスカーソルを置くことで、ICO球を生成する関数を確認することができます。  
この方法で確認することはできるのはメニューなどで提供されている機能に限りますが、非常に手軽に確認することができますので覚えておいて損はないでしょう。
![APIの調査](https://dl.dropboxusercontent.com/s/7blrr06i94597uh/blender_find_API.png "APIの調査")

続いて ```print("サンプル1: 3DビューにICO球を生成しました。")``` が呼ばれますが、 ```print()``` 関数は引数に指定した文字列を *コンソール* に表示する関数です。

最後に ```return``` で値を返していますが、返す値は以下のいずれかになります。
今回は処理が正常に終了したことを示す ```FINISHED``` を返しています。

|戻り値|値の説明|
|---|---|
|```FINISHED```|```execute()``` メソッドで行われた処理を確定します。<br>オペレーションが成功した時に指定します。|
|```CANCELLED```|```execute()``` メソッドで行われた処理を取り消します。<br>オペレーションが失敗した時に指定します。|
|```PASS_THROUGH```|オペレーションにより発行されたイベントを無視します。モーダルモード中にイベントを受けながす時に使用します。|
|```RUNNING_MODAL```|モーダルモードに移行します。|

ひとまずここでは ```FINISHED``` と、エラーが発生時にメソッドで行った処理を取り消す ```CANCELLED``` を覚えておけば良いでしょう。


### メニューを構築する関数

オペレーションクラスを作成しただけでは、メニューなどのUIには登録されません。
そこでまずは、メニューに登録時に呼ばれるメニュー構築関数 ```menu_fn()``` を作成します。
```menu_fn()``` は、後で解説するアドオン有効化・無効化時に呼ばれる関数の中で利用します。

```python
# メニューを構築する関数
def menu_fn(self, context):
	self.layout.separator()
	self.layout.operator(CreateObject.bl_idname)
```

メニューの編集は、 ```self.layout``` を用いることで行うことができます。
```self.layout.operator()``` の引数に ```CreateObject.bl_idname```を指定することにより、作成したオペーレーション用クラスの処理をメニューに登録することができます。
上記例ではさらに、新たに作成するメニュー項目と既存のメニュー項目とを分けるためのセパレータ（メニュー項目を区切る横線）を追加しています。
セパレータの追加は、 ```self.layout.separator()``` により行うことができます。

### アドオン有効化時に呼ばれる関数の作成

アドオン有効化時には ```register()``` 関数が呼ばれます。

```python
# アドオン有効化時の処理
def register():
	bpy.utils.register_module(__name__)
	bpy.types.INFO_MT_mesh_add.append(menu_fn)
	print("サンプル 1: アドオン「サンプル1」が有効化されました。")
```

```bpy.utils.register_module()``` は、引数に指定したモジュールを登録してBlender内で使えるようにする関数です。
引数に ```__name__``` を指定することで、ファイル内のモジュール全てを登録することができます。

```bpy.types.INFO_MT_mesh_add.append()``` 関数に、メニューを構築する関数である ```menu_fn()``` 関数を指定することで、 *3Dビュー* エリアのメニュー *追加* > *メッシュ* に項目を追加することができます。

<div id="column"></div>

```bpy.types.INFO_MT_mesh_add``` は ```bpy.types.INFO_MT_mesh_add.append()``` を確認した時と同様、 *3Dビュー* エリアのメニュー *追加* > *メッシュ* をマウスオーバーすることで確認することができます。  
ここでもしマウスオーバーした際にサブメニューが開いてしまって確認できない場合は、 *左キー* を押すことで確認することができるようになります。

最後は ```print()``` 関数で、 *コンソール* へアドオンが有効化されたことを示す文字列を出力しています。

### アドオン無効化時に呼ばれる関数の作成

アドオン無効化時には ```unregister()``` 関数が呼ばれます。

```python
# アドオン無効化時の処理
def unregister():
	bpy.types.INFO_MT_mesh_add.remove(menu_fn)
	bpy.utils.unregister_module(__name__)
	print("サンプル 1: アドオン「サンプル 1」が無効化されました。")
```

```bpy.types.INFO_MT_mesh_add.remove()``` に、メニューを構築する関数である ```menu_fn()``` 関数を指定することで、 *3Dビュー* エリアのメニュー *追加* > *メッシュ* からメニューを削除することができます。

```bpy.utils.unregister_module()``` は、引数に指定したモジュールを削除してBlenderから使えなくするようにする関数です。
こちらもアドオン有効化時に ```bpy.utils.register_module()``` 関数の引数に指定したものと同様、引数に ```__name__``` を指定してファイル内のモジュール全てを削除しています。

最後に ```print()``` 関数で、 *コンソール* へアドオンが無効化されたことを示す文字列を出力しています。

### メイン処理

*テキストエディター* のメニュー *テキスト* > *スクリプト実行* を実行した時に呼ばれる処理です。

![スクリプト実行 手順](https://dl.dropboxusercontent.com/s/b4hwarizgr6ikzd/blender_run_script.png "スクリプト実行 手順")

アドオンであればメイン処理は必要ありませんが、慣習として書くことが多いので書きました。
メイン処理では、単純にアドオン登録処理のみを行っています。

```python
# メイン処理
if __name__ == "__main__":
	register()
```

## まとめ

ICO球を3Dビュー上に生成するアドオンを作成し、アドオンのソースコードを解説しました。
非常にシンプルな機能しか持たないアドオンですが、覚えることが多く混乱された方も多いと思います。
しかし、ここでアドオン開発の流れをしっかり理解しておくことで、後の解説がスムーズに進むと思いますので、もし後の解説でわからなくなったら本節に戻ってきて復習することをおすすめします。

<div id="point"></div>

### ポイント

<div id="point_item"></div>

* Blenderが提供するAPIを使うためには、 ```bpy``` モジュールをインポートする必要がある
* ```bl_info``` 変数は、アドオンに関する情報を保存するための変数である
* アドオンの処理は ```bpy.types.Operation``` クラスを継承したオペレーション用クラスの ```execute()``` メソッドに記述する
* ```register()``` 関数はアドオンインストール時に呼ばれる関数であり、モジュールの登録やメニューの構築を行う処理を記述する
* ```unregister()``` 関数はアドオンアンインストール時に呼ばれる関数であり、モジュールの削除や構築したメニューの削除を行う処理を記述する
* *テキストエディター* からスクリプトを実行した時に呼ばれるメイン処理は、アドオン開発時には記載する必要はない
