# 2-1. サンプル1: アドオンからオブジェクトを生成する

前章の最後では非常にシンプルなアドオンを作成し、インストール＆アンインストールを行ってみました。
実際にソースコードを入力してもらったのですが、今の段階では何が何だかわからない状態だと思います。  

本章ではより実用的なアドオンを紹介しつつ、前章で説明できなかったソースコードの解説も行っていきますので、
前章でわからなかった点があっても諦めずに本章のサンプルを使いながら解説を読み進めていってください。
解説するサンプルは前章と異なりますが、今回紹介するサンプルを理解することで前章のサンプルを理解することができるようになっています。

## 作成するアドオンの仕様

前回はインストール・アンインストール時に、ターミナルやコマンドプロンプトにメッセージを出力する機能しかないアドオンでした。
今回は前回作成したアドオンとは異なり、より目に見える形の機能を作ってみたいと思います。

まず始めに、今回作成するアドオンの仕様を決めます。
非常に単純なサンプルにしたいので、以下のような仕様にしました。

* **3Dビュー** のメニュー **追加** > **メッシュ** に *球* を追加
* 追加したメニューを実行すると、 **3Dビュー** のメニューで **追加** > **メッシュ** > **ICO球** を選択した時と同等の効果を得る

**追加** > **メッシュ** > **ICO球** を実行すると以下のように、3DカーソルにICO球が作成されます。

![ICO球作成 手順1](https://dl.dropboxusercontent.com/s/z760a6xqpztgnhb/blender_generate_ico-sphere_1.png "ICO球作成 手順1")

![ICO球作成 手順2](https://dl.dropboxusercontent.com/s/4a1k4c68k8eteuv/blender_generate_ico-sphere_2.png "ICO球作成 手順2")

## アドオンを作成する

では早速、アドオンを作成してみましょう。
アドオンのソースコードを以下に示します。
ソースコードの解説は後ほど行いますので、 [1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に以下のソースコードを
**テキスト・エディタ** に入力し、 **sample_1.py** という名前で保存してください。

{% include "../../sample/src/chapter_02/sample_1.py" %}

## アドオンを実行する

解説を始める前に、作成したアドオンを使ってみましょう。
アドオンの動作を確認してから解説した方が理解が深まると思います。

### アドオンを有効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、作成したアドオンを有効化してみましょう。
インストールが正常に終了すると、 **コンソール** に以下の文字列が出力されるはずです。

```sh
サンプル 1: アドオン「サンプル1」が有効化されました。
```

### アドオンの機能を使ってみる

アドオンを有効化したら、 **3Dビュー** のメニューに **追加** > **メッシュ** > **球** が追加されていることを確認します。

![アドオンの実行 手順1](https://dl.dropboxusercontent.com/s/insl725bg08g8j4/blender_use_add-on_1.png "アドオンの実行 手順1")

続いて追加されたメニューを実行すると、3DカーソルにICO球が作成されたことを確認することができます。

![アドオンの実行 手順2](https://dl.dropboxusercontent.com/s/ek7n05o59hyhlp3/blender_use_add-on_2.png "アドオンの実行 手順2")

また、 **コンソール** に以下の文字列が出力されます。

```sh
サンプル 1: 3DビューにICO球を生成しました。
```

### アドオンを無効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、有効化したアドオンを無効化してください。
アドオンが無効化されると、 **コンソール** に以下の文字列が出力されるはずです。

```sh
サンプル 1: アドオン「サンプル 1」が無効化されました。
```

## ソースコードの解説

作成したアドオンのソースコードを解説していきます。

### bpyモジュールのインポート

Blenderのアドオンを開発するためには、 **bpyモジュール** をインポートしてBlender APIを利用できるようにする必要があります。
以下のコードにより、bpyモジュールをインポートすることができます。

```py:sample_1_part1.py
import bpy   # アドオン開発者に対して用意しているAPIを利用する
```

### bl_info変数の作成

Blenderのアドオンであることを、Blender本体に認識させるためには ```bl_info``` と呼ばれる変数を作成する必要があります。

```py:sample_1_part2.py
# アドオンに関する情報を保持する、bl_info変数
bl_info = {
	"name": "サンプル 1: オブジェクトを生成するアドオン",
	"author": "Nutti",
	"version": (1, 0),
	"blender": (2, 75, 0),
	"location": "Object > サンプル 1: オブジェクトを生成するアドオン",
	"description": "オブジェクトを生成するサンプルアドオン",
	"warning": "",
	"support": "TESTING",
	"wiki_url": "",
	"tracker_url": "",
	"category": "Object"
}
```

```bl_info``` はディクショナリ型で以下のようなキーと値で設定する必要があります。

|キー|値|
|---|---|
|name|アドオンの名前|
|author|アドオンの作者|
|version|アドオンのバージョン|
|blender|アドオンが動作するBlender本体の"最古"のバージョン<br>ここに指定されたバージョンより古いBlenderでアドオンをインストールすると警告が出る|
|location|アドオンが提供する機能のある場所|
|description|アドオンの説明文|
|warning|アドオンを使う時の注意点、バグ情報等|
|support|アドオンのサポートレベル|
|wiki_url|アドオンに関連する情報が得られるサイトのURL（ドキュメントサイト）|
|tracker_url|アドオンのサポートサイトのURL|
|category|アドオンのカテゴリ|

それぞれのキーに対して設定した値がBlenderのどこに反映されるか説明します。

* アドオンインストール時の **ユーザ設定** 画面に保存されるもの

```name```, ```author```, ```version```, ```location```, ```description```, ```warning```, ```wiki_url```, ```tracker_url```は、アドオンを有効化した時に確認した **ユーザ設定** に反映されるものです。
今回作成したアドオンについて、表示内容と設定内容を見比べてみましょう。

![bl_info 解説1](https://dl.dropboxusercontent.com/s/ko8lslcvcw84ras/blender_bl-info_1.png "bl_info 解説1")

```warning```, ```wiki_url```, ```tracker_url``` については、今回のアドオンでは設定していないため表示されていません。
実際これらの変数に値を設定すると、 **ユーザ設定** にどのように反映されるか見てみたいと思います。
```bl_info``` を以下のように書き換えてアドオンを有効化してみます。

```py:sample_1_part2_alt.py
# アドオンに関する情報を保持する、bl_info変数
bl_info = {
	"name": "サンプル 1: オブジェクトを生成するアドオン",
	"author": "Nutti",
	"version": (1, 0),
	"blender": (2, 75, 0),
	"location": "Object > サンプル 1: オブジェクトを生成するアドオン",
	"description": "オブジェクトを生成するサンプルアドオン",
	"warning": "本アドオンはサンプルです",
	"support": "TESTING",
	"wiki_url": "https://www.gitbook.com/book/nutti/introduction-to-add-on-development-in-blender/",
	"tracker_url": "https://github.com/nutti/Introduction-to-Add-on-Development-in-Blender",
	"category": "Object"
}
```

![bl_info 解説2](https://dl.dropboxusercontent.com/s/pxe76rmhdanmmpw/blender_bl-info_2.png "bl_info 解説2")

新たに情報を追加したことで **ユーザ設定** にも反映されています。
**ドキュメント編集** をクリックすると ```wiki_url``` に指定したURLが開きますので、 アドオンのドキュメントや本アドオンの最新情報が得られるサイトのURLを
 ```wiki_url``` に設定するようにしましょう。
今回は、本書の本体のURLを設定してみました。

**バグを報告** をクリックすると、 ```tracker_url``` に指定したURLを開くことができます。
アドオンのバグを報告するサイトをお持ちの方でユーザからのフィードバックを得たい方は、この値を設定しておくと良いかと思います。
本書は **GitHub** と呼ばれるOSSホスティングサービスで管理しているので、GitHub上の本プロジェクトのURLを設定してみました。

*  ```blender```

アドオンが動作する最古のバージョンを指定します。
ここで指定したバージョンより古いバージョンのBlenderで実行すると警告メッセージが表示されます。
試しにどのように警告メッセージが表示されるか見てみましょう。
```blender``` に ```(2, 76, 0)``` を指定してアドオンを有効化してみてください。
すると、図のように警告メッセージが表示されるはずです。

＠＠＠図を追加＠＠＠

警告が表示されるだけですので、 ```blender``` に指定したバージョンよりも古いバージョンで運よく動作すれば、
警告を無視してアドオンを使うことができてしまいます。
アドオンをテストしたバージョンよりも、古いBlenderでの実行をサポートしたくない場合に指定すると良いでしょう。

* ```support```

アドオンのサポートレベルを以下の3つから設定します。
[1.2節](../chapter_01/02_Use_Blender_Add-on.md)で説明したアドオンのサポートレベルを参考に設定してください。

|設定値|ユーザ設定上の表示|設定値の意味|
|---|---|---|
|```OFFICIAL```|公式|Blenderが公式にサポートしているアドオンです。サポートレベルが **Release** のアドオンに対して設定します。|
|```COMMUNITY```|コミュニティ|Blenderが公式にサポートしていないアドオンです。サポートレベルが **Official** あたは **External** のアドオンに対して設定します。|
|```TESTING```|テスト中|テスト中のアドオンに対して設定します。機能が不完全な場合やテスト中の場合に設定します。|

**ユーザ設定** では、サポートレベルに応じてインストールされたアドオンをフィルタリングすることが可能です。
サンプルアドオンは ```support``` に ```TESTING``` を設定することで、 **テスト中** のボタンのみを選択して表示されるアドオン
```support``` に ```TESTING``` が設定されたもののみに絞り、サンプルアドオンを素早く検索できるようにしました。
以降のサンプルアドオンでも同様です。

＠＠＠図を追加＠＠＠

* ```category```

アドオンのカテゴリを指定します。
以下の図に示している、 **ユーザ設定** のカテゴリにあるものを指定すると良いでしょう。
日本語化している方は一度英語に戻して、カテゴリの正式名称を確認しましょう。

＠＠＠図を追加＠＠＠

カテゴリの設定は自由に行るため、新たなカテゴリを作ることもできます。
```category``` に ```Sample``` を指定してみましょう。
新たなカテゴリとして、 ```Sample``` が追加されていることがわかると思います。

＠＠＠図を追加＠＠＠

### オペレーション用クラスの作成

アドオンからBlenderに対して操作するためには、オペレーション用のクラスを作成し処理を記述する必要があります。
オペレーション用のクラスは、 ```bpy.types.Operator``` を継承して作成する必要があります。
作成したクラスは、以下のようなメンバ変数を含める必要があります。

|メンバー変数|値|
|---|---|
|```bl_idname```|Blender内部で使用するID|
|```bl_label```|メニューに登録した時に、メニュー項目に表示される文字列|
|```bl_description```|メニューに登録した時に、メニュー項目に表示される説明文|
|```bl_options```|オペレーションへ追加するオプション|

```bl_idname``` は自由に決めてもらって良いですが、 ```<アドオンのカテゴリ>.<任意の文字列>``` のように指定します。
今回はカテゴリが **OBJECT** であることから、IDを ```object.create_object``` としました。  
```bl_options``` には、オペレーションに対するオプションを、キーのみ指定した辞書で指定します。
今回は メニューへ登録するための ```REGISTER``` とオペレーションを取り消すことを可能にするための ```UNDO``` を指定しました。

```bl_label``` と ```bl_description``` に指定した内容は、追加したメニュー項目から確認することができます。

続いて、オペレーションの処理本体を作成します。
メニューを実行した時など、オペレーションが実行された時は ```exexute()``` メソッドが呼ばれます。
```execute()``` メソッドが呼ばれると、以下の引数がBlender本体から渡されてきます。
今回はこれらの引数を利用していないため、特に意識する必要はありません。

|引数|値|
|---|---|
|```self```|オペレーションクラスのインスタンス|
|```context```|オペレーションが実行された時の状態|

```execute()``` メソッドの中身を見てみましょう。
最初に、 ```bpy.ops.mesh.primitive_ico_sphere_add()``` という関数を呼んでいます。
これはBlenderが用意しているAPIの1つで、 **3Dビュー** 上にICO球を作成することができます。
この関数は複数の引数を取りますが、今回は引数を1つも指定していないので3DカーソルにICO球が生成されます。
```bpy.ops.mesh.primitive_ico_sphere_add()``` は引数として例えば以下のようなものを取ります。
先ほど示したソースコードに引数を指定して、実行してみましょう。

＠＠＠＠＠

続いて ```print("サンプル1: 3DビューにICO球を生成しました。")``` が呼ばれますが、
```print()``` 関数は、引数に指定した文字列を **コンソール・ウィンドウ** に表示する関数です。

最後に ```return``` で値を返していますが、返す値は以下のいずれかになります。
今回は処理が正常に終了したことを示す、 ```FINISHED``` を返しています。

|戻り値|値|
|---|---|
|```FINISHED```|```execute()``` メソッドで行われた処理を確定します。<br>オペレーションが成功した時に指定します。|
|```CANCELLED```|```execute()``` メソッドで行われた処理を取り消します。<br>オペレーションが失敗した時に指定します。|
|```PASS_THROUGH```|オペレーション発行イベントを無視します。|
|```RUNNING_MODAL```|オペレーションを実行中の状態にします。|

ここでは、```FINISHED``` とエラーが発生した時に利用する ```CANCELLED``` を覚えておけば良いでしょう。


### メニューを構築する関数

オペレーションクラスを作成しただけでは、メニュー等のUIには登録されません。
そこでまずは、メニューに登録するためにメニューを構築する関数 ```menu_fn()``` を作成します。
```menu_fn()``` は、後で解説するアドオン有効化・無効化時に利用します。
それでは、 ```menu_fn()``` の中身を見ていきましょう。

メニュー項目の編集は、 ```self.layout``` を用いることで行うことができます。
```self.layout.operator()``` の引数に ```CreateObject.bl_idname```を指定することにより、
作成したオペーレーションをメニューに登録することができます。
今回は、新たに作成するメニュー項目と既存のメニュー項目とを分けるためのセパレータ（メニュー項目を区切る横線）を追加しています。
セパレータの追加は、 ```self.layout.separator()``` により行うことができます。

### アドオン有効化時に呼ばれる関数の作成

アドオン有効化時は、 ```register()``` 関数が呼ばれます。
