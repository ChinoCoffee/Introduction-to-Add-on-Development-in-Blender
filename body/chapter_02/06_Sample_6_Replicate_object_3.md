# 2-6. サンプル6: オブジェクトを複製する3

Blenderの機能やアドオンにはショートカットキーを割り当てて、頻繁に使う機能を素早く実行できるようにしているものがあります。
例えば、 *オブジェクト* > *トランスフォーム* > *移動* には Gキーが割り当てられてます。

個人で作成するアドオンでもBlenderの機能と同様、機能にショートカットキーを割り当てることができます。
本節では [2.4節](04_Sample_4_Replicate_object_1.md) を改良し、自作のアドオンの機能にショートカットキーを割り当てる方法を紹介します。

## 作成するアドオンの仕様

* [2.4節](04_Sample_4_Replicate_object_1.md)で作成したサンプルについて、 *3Dビュー* のメニュー *オブジェクト* > *選択オブジェクトの複製* にショートカットキー（ctrl + alt + R）を割り当てる

## アドオンを作成する

以下のソースコードを、 [1.4節](../chapter_01/04_Install_own_Add-on.md)を参考にして **テキスト・エディタ** に入力し、
**sample_6.py** という名前で保存してください。

[import](../../sample/src/chapter_02/sample_6.py)

## アドオンを実行する

### アドオンを有効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、作成したアドオンを有効化すると **コンソール** に以下の文字列が出力されます。

```sh
サンプル 6: アドオン「サンプル6」が有効化されました。
```

### アドオンを使ってみる

アドオンを有効化したら、 *3Dビュー* 上でオブジェクトを選択して *ctrl* + *alt* + *R* キーを押してください。
*オブジェクト* > *選択オブジェクトの複製* を実行した時と同様の効果が得られていることがわかります。
以下の図は、 *Cube* を選択して上記キーを押した時のものです。

![オブジェクトの複複](https://dl.dropboxusercontent.com/s/sqzwdwfgs245mp6/use_add-on_1.png "オブジェクトの複製")

### アドオンを無効化する

[1.4節](../chapter_01/04_Install_own_Add-on.md)を参考に、有効化したアドオンを無効化すると **コンソール** に以下の文字列が出力されます。

```sh
サンプル 6: アドオン「サンプル 6」が無効化されました。
```

## ソースコードの解説

### ショートカットキーの割り当て

ショートカットキーの割り当ては、 ```register_shortcut()``` 関数で行います。

```py:sample_6_part1.py
def register_shortcut():
    wm = bpy.context.window_manager
    kc = wm.keyconfigs.addon
    if kc:
        # 3Dビューのショートカットキーとして登録
        km = kc.keymaps.new(name="3D View", space_type="VIEW_3D")
        # ショートカットキーの登録
        kmi = km.keymap_items.new(
            idname=ReplicateObject.bl_idname,
            type="R",
            value="PRESS",
            shift=False,
            ctrl=True,
            alt=True)
        # ショートカットキー一覧に登録
        addon_keymaps.append((km, kmi))
```

```bpy.context.window_manager.keyconfigs.addon.keymaps``` はアドオンに割り当てられているキーマップです。
```keymaps.new()``` 関数を実行することで、新たにキーマップを割り当てることができます。
今回は ```keymaps.new()``` に以下に示す引数を指定してキーマップを割り当てています。

|引数|値の意味|
|---|---|
|```name```|キーマップ名|
|```space_type```|キーマップを割り当てるウィンドウ（3Dビューなど）|

キーマップを割り当てた後は、 ```km.keymap_items.new()``` 関数により新しいキーマップにショートカットキーを登録していきます。
```km.keymap_items.new()``` 関数に指定する引数は以下の通りです。

|引数|値の意味|
|---|---|
|```idname```|実行する処理のオペレーション用クラスの ```bl_idname``` |
|```type```|ショートカットに割り当てるキーボードのキー|
|```value```|イベント|
|```shift```|shiftキーが押されている必要がある時は ```True```|
|```ctrl```|ctrlキーが押されている必要がある時は ```True```|
|```alt```|altキーが押されている必要がある時は ```True```|

今回は、 *shift + ctrl + R* が押された時にオブジェクトの複製の処理を実行するように、引数を設定しています。
```value``` に設定したイベントが発生した時に、 ```idname``` に指定した処理を実行しますが、 ```value``` には例えば以下のようなイベントを設定できます。

|イベント|値の意味|
|---|---|
|```PRESS```|ボタンを押した時に処理を実行する|
|```RELEASE```|ボタンを話した時に処理を実行する|
|```ANY```|何かしらイベントを受け取った時に処理を実行する|
|```NOTHING```|イベントを受け取っても処理を実行しません|

最後に、割り当てたキーマップとショートカットキーのペアをグローバル変数 ```addon_keymaps``` に保存します。
この変数はアドオンを無効化時に、機能に割り当ててたショートカットを解除するために必要になります。

### ショートカットキーの割り当て解除

アドオン内で登録したショートカットキーは、割り当てを解除する必要があります。
ショートカットキーの割り当て解除は、 ```unregister_shortcut()``` 関数で行います。

```py:sample_6_part2.py
def unregister_shortcut():
    for km, kmi in addon_keymaps:
        # ショートカットキーの登録解除
        km.keymap_items.remove(kmi)
    # ショートカットキー一覧をクリア
    addon_keymaps.clear()
```

変数 ```addon_keymaps``` に保存しておいたキーマップを用いて、 ```keymap_items.remove()``` によりショートカットキーのペアを削除しています。
最後に、キーマップとショートカットキーのペアを保存しておいた ```addon_keymaps``` をクリアします。

### 割り当てるショートカットキー

Blenderでは既にたくさんの機能にショートカットキーが割当たっているので、単一のキーの中から何も割当たっていないキーを探すのが意外と大変です。
そのような時は、*ctrlキー* や *shiftキー* 、 *altキー* との組み合わせに目を向けてみましょう。
これらのキーと組み合わせたショートカットキーは、単一のキーに比べて同一のキーがすでに割り当てられている可能性が低いため、割と簡単に空いているキーを見つけることができると思います。
今回のサンプルでも、ctrlキーやaltキーを組み合わせたショートカットキーを登録しています。

また、割り当てるショートカットキーは機能との関連性がわかるようにしましょう。
例えば今回ショートカットキーを割り当てた機能であるオブジェクトの複製は、英訳するとReplicate Objectになるため、英訳の頭文字を取ってRキーを割り当てています。

## まとめ

[2.4節](04_Sample_4_Replicate_object_1.md) を改造し、*3Dビュー* のメニュー *オブジェクト* > *選択オブジェクトの複製* にショートカットキーを割り当てて、メニューから選ばずにショートカットキーから実行できるようにしました。
ショートカットキーを機能に割り当てることで、ユーザが機能へ素早くアクセスできるようになります。

頻繁に使う機能に対してショートカットキーを割り当てることは、アドオンの利便性の改善に繋がる可能性があります。しかしその反面、ショートカットキーに設定できる組み合わせには限りがあるため、ショートカットキーを乱用して利用可能なショートカットキーを減らしてしまうのはよくありません。

アドオンを様々な人に使ってもらうことを考えている場合、ショートカットキーを設定する時は、必ずユーザにとって無くてはならないくらい利便性を向上させるものであるか考えてから設定するようにしましょう。個人的に利用するアドオンでない限り、試しにつけてみたとか、あればよいな程度のショートカットキーは設定すべきではありません。

### ポイント

* ウィンドウごとのキーマップを割り当てた後に、ショートカットキーを割り当てることで、機能にショートカットキーを割り当てることができる
* キーマップは、 ```bpy.context.window_manager.keyconfigs.addon.keymaps.new()``` 関数を実行することにより割り当てることができる
* ショートカットキーは、 キーマップ ```km``` について ```km.keymap_items.new()``` 関数を実行することにより割り当てることができる
* 割り当てたショートカットキーは、アドオン無効化時に登録解除する必要がある
