<div id="sect_title_img_4_5"></div>

<div id="sect_title_text"></div>

# アドオンの動作テストを自動化する

<div id="preface"></div>

###### [4-3節](03_Publish_your_Add-on.md) にて説明しましたが、アドオンを公開した後はバグ修正や機能追加などアドオンのサポートをきちんと行うべきです。しかし、アドオンのソースコードを修正する度にアドオンの動作テストを毎回行うのは、特にアドオンの規模が大きくなってくると大変です。本節では、Blenderのコマンドライン実行を活用してアドオンの動作テストを自動化する方法を紹介します。


## アドオンの動作テストを自動化する利点

バグ修正や新機能追加によりソースコードを修正したことで、これまで正しく動作していた既存の機能が正しく動かなくなることは、ソフトウェアでバグが発生する原因の1つです。ソースコードを修正しなければこのようなことは起こりませんが、これでは根本的な問題解決になりません。ソースコードを修正したことでバグが発生するのは、修正の影響がどこまで及んでいるのかをきちんと把握できていないことが原因です。しかし、ソースコードを修正するたびに既存の機能のテストを毎回手作業で行っていたのでは、時間がいくらあっても足りません。一方、Blenderのアドオンの場合は一般のソフトウェアと異なり、BlenderのバージョンによってAPIが変更されてしまうことで今まで動作していた機能が正しく動作しなくなるという問題もあります。新しいバージョンのBlenderがリリースされる度に、アドオンのすべての機能をテストするのも非常に大変です。

このように、アドオンのテストには想像しているよりも非常に手間がかかることが分かると思います。そこで、毎回同じことを繰り返すようなテストは自動化してしまい、本来の修正作業に集中しましょう。


## コマンドラインからBlenderを実行

BlenderはGUIベースのソフトウェアですので、アドオンの機能が正しく動作していることを動作確認するためにはマウスやキーボードを使った操作が必要になるため、テストを自動化することが難しいと感じるかもしれません。しかし幸いなことに、BlenderはコマンドラインでPythonスクリプトを実行するモード（CUIモード）が標準で備わっているため、CUIモードを活用してアドオンのテストを自動化することができます。

Blenderをコマンドラインから実行するためには、[1-3節](../chapter_01/03_Prepare_Add-on_development_environment.md) で紹介した通り、ターミナルを開きBlenderの実行ファイルを実行します。しかし、[1-3節](../chapter_01/03_Prepare_Add-on_development_environment.md) で紹介した方法では、BlenderがGUIモードで起動してしまいます。CUIモードで起動するためには、```--backgroud``` オプションをつけて実行します。以降の説明では、Blenderの実行ファイルが置かれているパスが ```/path/blender``` とします。

```sh
$ /path/blender --background
```

上記のコマンドを実行すると、BlenderがCUIモードで起動後にBlenderが終了します。しかしこれだけでは、CUIモードでBlenderが起動して終了するだけで意味がありません。CUIモードが強力なのは、オプション ```--python``` の引数に指定したPythonスクリプトを実行できることにあります。例えば、レンダリング処理を実行するPythonスクリプトを作成し、高性能なレンダリングを行うサーバでCUI実行することで、ネットワークレンダリングを行うことができます。また、過去に作成した.blendファイルに対してPythonスクリプトを使って同じ処理を繰り返したい場合にも、コマンドラインから実行することで作業時間を短縮することができます。

ここでは試しに簡単なPythonスクリプトを作成し、BlenderのCUIモードで作成したスクリプトを実行してみましょう。次のスクリプトを作成し、```/path/blender``` と同一ディレクトリに、```run_script_on_cui_mode.py``` の名前で保存します。

```python
a = 50
b = 12
print("a+b=%d" % (a+b) )
```

次にターミナルから以下のコマンドを実行します。

```sh
$ /path/blender --background --python run_script_on_cui_mode.py
```

コマンドを実行すると次のメッセージが出力された後、Blenderが終了します。

```sh
a+b=62
```

このように、BlenderのCUIモードでPythonスクリプトを実行することができます。CUIモードでPythonスクリプトが実行できることを利用し、アドオンの機能をテストするスクリプトを実行することで、GUIモードでマウスやキーボードを用いることなくアドオンのテストを行うことができます。しかし、CUIモードでBlenderを起動しただけではアドオンが有効化されていません。作成したアドオンをCUIモードで有効化してBlenderを実行するためには、```--addons``` オプションの引数に有効化したいアドオンのパッケージまたはモジュール名を指定します。例えば、モジュール名が ```addon_test``` であれば以下のコマンドを実行することで、アドオン ```addon_test``` が有効化された状態でスクリプト ```run_script_on_cui_mode.py``` を実行します。

```sh
$ /path/blender --background --addons addon_test --python run_script_on_cui_mode.py
```

## アドオンの機能をスクリプトから実行する

有効化されているアドオンの機能は、[2-2節](../chapter_02/02_Register_Multiple_Operation_Classes.md) で紹介したように、オペレータクラスの ```bl_idname``` が ```bpy.ops.<オペレーションクラスのbl_idname>``` として登録されることを利用し、スクリプトから実行することができます。

テストするアドオンを有効化した状態でBlenderを実行し、アドオンの機能をスクリプトから実行することで、アドオンのテストを行うことになります。すなわち、アドオンの動作確認を行うためにマウスやキーボードを用いて行なっていたことを、Blenderが提供するAPIを使って実現する必要があります。このため、処理によってはスクリプトで実現できない可能性があることに注意が必要です。


## アドオンの動作テストを自動化する方法

CUIモードでスクリプトを実行する方法を紹介しましたが、これを用いてアドオンの動作テストを自動化する方法を紹介します。アドオンの動作テストを自動化する方法として、ここではGitHubとTravis CIを連携してアドオンをGitHubのリポジトリにコミットした時にテストを行うための方法を紹介します。

### GitHubに登録する

GitHubについては、[4-3節](03_Publish_your_Add-on.md) にて紹介しましたが、GitHubの機能の1つに外部サービスとの連携があります。外部サービスと連携することにより、更新したソースコードをコミットした時に外部サービスを利用し、そのコミットが正常であるかを確認することができます。GitHubの登録の仕方についてはすでに多くの情報がWeb上で紹介されているため、本書では割愛します。

Web上などの情報を参考にして、GitHubにリポジトリを作成します。本節では、```Testing_Blender_Addon_With_Travis_CI``` というリポジトリを作成することを前提に説明します。作成したリポジトリはTravis CIと連携することで、リポジトリに対してコミットされるとテストが自動的に行われるようにします。

### Travis CIに登録する

GitHubについてはアドオンをよく利用されている方であれば、知っている方も多いと思います。一方、Travis CIについては名前すら知らないという方もいるかと思いますので簡単に紹介します。

CIとはContinuous Integration(継続的インテグレーション)の略で、ソースコードのビルドやテストをソースコード更新のたびに行うことを示しています。ソースコードを修正すると、これまで動作していた機能が動作しなくなるといった問題が生じることがあると書きましたが、このようなことが起こらないようにするために、常にソースコードをテストして問題の発生をできるだけ早く見つけるというのがCIを行う理由の1つです。CIサービスはCIの実践を支援するサービスで、ソースコードをリポジトリにコミットした時にテストやビルドを自動的に行い、その結果を表示するサービスです。Travis CIはCIを支援するサービスの1つでCIサービスには他にもJenkinsなどがありますが、本書ではGitHubと連携が簡単なTravis CIを使って説明します。

Travis CIへの登録の仕方についても、本書では割愛します。すでにGitHubアカウントを持っていれば特別必要な作業は不要かと思います。

### GitHubとTravis CIを連携する

GitHubとTravis CIとの連携は、次の手順で行います。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|右上のユーザのアイコンから *Accounts* をクリックしてアカウント情報を表示すると、GitHubで作成したリポジトリの一覧が表示されますので、テスト対象のリポジトリを有効化します。|![ポップアップメッセージボタン 手順1](https://dl.dropboxusercontent.com/s/os3tka7asic48ai/popup_message_1.png "ポップアップメッセージボタン 手順1")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">2</div>|リポジトリ有効化ボタンの隣にある歯車マークをクリックすると、テスト（ビルド）を実行する契機を確認することができます。|![ポップアップメッセージボタン 手順1](https://dl.dropboxusercontent.com/s/os3tka7asic48ai/popup_message_1.png "ポップアップメッセージボタン 手順1")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|デフォルトでは *Build pushes* （プッシュ時に実行）と *Build pull requests* （プルリクエスト時に実行）の2つが有効化されています。|![ポップアップメッセージボタン 手順1](https://dl.dropboxusercontent.com/s/os3tka7asic48ai/popup_message_1.png "ポップアップメッセージボタン 手順1")|
|---|---|---|



<div id="process_start_end"></div>

---


上記の手順を見てもらえばわかると思いますが、GitHubとTravis CIとの連携はクリックを数回行うことで完了します。

### テスト対象のアドオンの作成

本節でテスト対象とするアドオンを作成します。ファイル名 ```testee.py``` として作成します。

[import](../../sample/src/chapter_04/sample_4-5/testee.py)

テスト対象のアドオンでは、2つのオペレータクラスが定義されています。```TestOps1``` は何もせずに ```{'FINISHED'}``` を返すオペレーションが定義されています。```TestOps2``` はオブジェクト名がCubeであるオブジェクトが存在する場合に ```{'FINISHED'}``` 、存在しない場合に ```{'CANCELLED'}``` を返すオペレーションが定義されています。

### アドオンテスト用スクリプトの作成

アドオンをテストするためのスクリプトを作成します。本節では、ファイル名 ```test.py``` として作成します。

[import](../../sample/src/chapter_04/sample_4-5/test.py)


スクリプト自体は単純で、```testee.py``` で登録するオペレータクラスの ```bl_idname``` を使ってアドオンの機能を呼び出すだけです。アドオンの機能を呼び出した後は、その戻り値を ```assert``` 文で判定します。第1引数の条件が偽の場合に、第2引数に指定した文字列が表示されてテストがエラー終了します。アドオンの機能を実行した時の戻り値が期待したものではなかった場合にエラーとなるようにスクリプトを作成することで、アドオンが正常に動作しているのかを確認することができます。

Blender実行開始時にはオブジェクト名がCubeであるオブジェクトが最初から作られているため、作成したアドオン ```testee.py``` で定義した全てのオペレーションは ```{'FINISHED'}``` で返るため


### .travis.ymlの作成

### 作成したアドオンのソースコードをコミット

### テスト結果を確認する


## まとめ




<div id="point"></div>

### ポイント

<div id="point_item"></div>

*
